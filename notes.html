<!doctype html>
<html lang="en">
<head>
<title>DNS &amp; BIND 9 Leap-Ahead Online Training</title>
<!-- 2024-10-30 Wed 18:14 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="BlueCat Learning Team">
<link href="css/bootstrap.css" rel="stylesheet"><link href="css/training.css" rel="stylesheet"><script src="js/jquery.js"></script><script src="js/bootstrap.js"></script><script src="js/anim.js"></script>
<script>
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-3 col-md-push-9"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Course Notes and exercises</a>
<ul class="nav">
<li><a href="#sec-1-1">1.1. Introduction</a></li>
<li><a href="#sec-1-2">1.2. Virtual machines for this lab</a></li>
<li><a href="#sec-1-3">1.3. Access to the lab  machines</a></li>
</ul>
</li>
<li><a href="#sec-2">2. New terminology used in DNS &amp; BIND</a></li>
<li><a href="#sec-3">3. Building the authoritative DNS server</a>
<ul class="nav">
<li><a href="#sec-3-1">3.1. Enable ISC BIND 9 repository for Enterprise Linux 9</a></li>
<li><a href="#sec-3-2">3.2. Installing BIND 9.20</a></li>
<li><a href="#sec-3-3">3.3. Solution "Building an authoritative DNS Server":</a></li>
<li><a href="#sec-3-4">3.4. Create a primary zone</a></li>
<li><a href="#sec-3-5">3.5. Register the zone on a secondary server</a></li>
</ul>
</li>
<li><a href="#sec-4">4. A quick look at DNSSEC</a>
<ul class="nav">
<li><a href="#sec-4-1">4.1. DNS Security (or lack of)</a></li>
<li><a href="#sec-4-2">4.2. DNSSEC</a></li>
<li><a href="#sec-4-3">4.3. The chain of trust in DNS</a></li>
</ul>
</li>
<li><a href="#sec-5">5. DNSSEC in a nutshell</a>
<ul class="nav">
<li><a href="#sec-5-1">5.1. DNSSEC key algorithms</a></li>
<li><a href="#sec-5-2">5.2. DNSSEC records</a></li>
</ul>
</li>
<li><a href="#sec-6">6. DNSSEC signing and validation</a></li>
<li><a href="#sec-7">7. DNSSEC validation (simplified)</a></li>
<li><a href="#sec-8">8. Building a validating DNS Resolver</a>
<ul class="nav">
<li><a href="#sec-8-1">8.1. Enable ISC BIND 9 repository for Enterprise Linux 9</a></li>
<li><a href="#sec-8-2">8.2. Installing BIND 9.20</a></li>
<li><a href="#sec-8-3">8.3. Optimizations to the default configuration</a></li>
</ul>
</li>
<li><a href="#sec-9">9. EDNS - Response Size Limits in DNS</a>
<ul class="nav">
<li><a href="#sec-9-1">9.1. The early years - 512byte is enough</a></li>
<li><a href="#sec-9-2">9.2. RFC 1035</a></li>
<li><a href="#sec-9-3">9.3. The 13 Root DNS Servers</a></li>
<li><a href="#sec-9-4">9.4. DNS over TCP</a></li>
<li><a href="#sec-9-5">9.5. New developments in DNS</a></li>
<li><a href="#sec-9-6">9.6. EDNS0</a></li>
<li><a href="#sec-9-7">9.7. ENDS0 features</a></li>
<li><a href="#sec-9-8">9.8. EDNS1 (2,3,4 &#x2026;)</a></li>
</ul>
</li>
<li><a href="#sec-10">10. DNS resolver best practices</a>
<ul class="nav">
<li><a href="#sec-10-1">10.1. Prevent DNS fragmentation</a></li>
<li><a href="#sec-10-2">10.2. minimal responses and minimal any</a></li>
<li><a href="#sec-10-3">10.3. Empty Zones - Protecting the Internet from Useless Queries</a></li>
<li><a href="#sec-10-4">10.4. Prefetch</a></li>
</ul>
</li>
<li><a href="#sec-11">11. 'dig'ing deeper</a>
<ul class="nav">
<li><a href="#sec-11-1">11.1. dig</a></li>
<li><a href="#sec-11-2">11.2. dig Query Options</a></li>
<li><a href="#sec-11-3">11.3. dig +[no]cmd</a></li>
<li><a href="#sec-11-4">11.4. dig +[no]stats</a></li>
<li><a href="#sec-11-5">11.5. dig +nocmd +nostats</a></li>
<li><a href="#sec-11-6">11.6. dig +comment</a></li>
<li><a href="#sec-11-7">11.7. dig +comment</a></li>
<li><a href="#sec-11-8">11.8. dig +question</a></li>
<li><a href="#sec-11-9">11.9. dig +answer</a></li>
<li><a href="#sec-11-10">11.10. dig +authority</a></li>
<li><a href="#sec-11-11">11.11. dig +additional</a></li>
<li><a href="#sec-11-12">11.12. dig +qr</a></li>
<li><a href="#sec-11-13">11.13. dig +short</a></li>
<li><a href="#sec-11-14">11.14. Truncate &amp; dig +ignore</a></li>
<li><a href="#sec-11-15">11.15. DNSSEC troubleshooting</a></li>
</ul>
</li>
<li><a href="#sec-12">12. Getting information</a>
<ul class="nav">
<li><a href="#sec-12-1">12.1. Statistics</a></li>
<li><a href="#sec-12-2">12.2. Query Logging</a></li>
<li><a href="#sec-12-3">12.3. Packet Capture (Passive Replication)</a></li>
<li><a href="#sec-12-4">12.4. DNSTAP</a></li>
<li><a href="#sec-12-5">12.5. CHAOS: An Information Source (Built-in server information zones)</a></li>
</ul>
</li>
<li><a href="#sec-13">13. DNS cookies</a>
<ul class="nav">
<li><a href="#sec-13-1">13.1. Protection for the Querier</a></li>
<li><a href="#sec-13-2">13.2. Protection for the Domain Name Owner/Publisher</a></li>
<li><a href="#sec-13-3">13.3. Protection for the Innocent</a></li>
<li><a href="#sec-13-4">13.4. Protection for the DNS Server</a></li>
<li><a href="#sec-13-5">13.5. DNS Client Cookies</a></li>
<li><a href="#sec-13-6">13.6. DNS Server Cookies</a></li>
<li><a href="#sec-13-7">13.7. Off-Path Attacks</a></li>
<li><a href="#sec-13-8">13.8. Client/Server Support</a></li>
<li><a href="#sec-13-9">13.9. DNS Cookie Facts</a></li>
<li><a href="#sec-13-10">13.10. Cookies: Initial Query</a></li>
<li><a href="#sec-13-11">13.11. Cookies: Initial Query Response</a></li>
<li><a href="#sec-13-12">13.12. Cookies: Client Security</a></li>
<li><a href="#sec-13-13">13.13. Cookies: Client Caching</a></li>
<li><a href="#sec-13-14">13.14. Cookies: Subsequent Queries</a></li>
<li><a href="#sec-13-15">13.15. Cookies: Valid Server Cookie</a></li>
<li><a href="#sec-13-16">13.16. Cookies: Invalid Server Cookie</a></li>
<li><a href="#sec-13-17">13.17. Cookies in BIND 9</a></li>
<li><a href="#sec-13-18">13.18. Cookies in dig: Server Cookie</a></li>
<li><a href="#sec-13-19">13.19. Cookies in dig: Client Cookie</a></li>
<li><a href="#sec-13-20">13.20. Exercise</a></li>
</ul>
</li>
</ul>
</div>
</nav>
</div><div class="col-md-9 col-md-pull-3"><h1 class="title">DNS &amp; BIND 9 Leap-Ahead Online Training</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Course Notes and exercises</h2>
<div class="outline-text-2" id="text-1">
<p>
This page contains the course notes and exercise instructions for
attendees of the online training <b>DNS &amp; BIND Leap-Ahead</b>.
</p>

<p>
Alternative location for this website:
<a href="https://cstrotm.github.io/dns-leap-ahead-training-page.github.io/">https://cstrotm.github.io/dns-leap-ahead-training-page.github.io/</a>
</p>

<p>
Click on images to zoom in.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Introduction</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>What is your interest in DNS?
</li>
<li>What is your prior knowledge of DNS?
</li>
<li>What do you want to learn about DNS?
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Virtual machines for this lab</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>User : <code>user</code>
</li>
<li>Password: <code>DNSandBIND</code>
</li>
<li>Root-Shell via <code>sudo -s</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Access to the lab  machines</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Each student has three lab machines for the <b>DNS Leap Ahead</b>
training course

<ul class="org-ul">
<li>A DNS resolver: <code>dnsrNN.dnslab.org</code> (New York, US)
</li>
<li>A primary authoritative DNS: <code>nsNNa.dnslab.org</code> (Toronto, CA)
</li>
<li>A secondary authoritative DNS: <code>nsNNb.dnslab.org</code> (London, UK)
</li>
</ul>
</li>

<li>During the training course labs, replace <code>NN</code> with your student
number
</li>
</ul>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="right">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="text-right">NN</th>
<th scope="col" class="text-left">Name</th>
<th scope="col" class="text-left">URL for Web-based Terminal</th>
<th scope="col" class="text-left">SSH Access</th>
<th scope="col" class="text-left">Zone</th>
</tr>
</thead>
<tbody>
<tr>
<td class="text-right">01</td>
<td class="text-left">Matej Ćosić</td>
<td class="text-left"><a href="https://dnsr01.dnslab.org">https://dnsr01.dnslab.org</a></td>
<td class="text-left">ssh user@dnsr01.dnslab.org</td>
<td class="text-left">zone01.dnslab.org</td>
</tr>

<tr>
<td class="text-right">02</td>
<td class="text-left">Darren Ankney</td>
<td class="text-left"><a href="https://dnsr02.dnslab.org">https://dnsr02.dnslab.org</a></td>
<td class="text-left">ssh user@dnsr02.dnslab.org</td>
<td class="text-left">zone02.dnslab.org</td>
</tr>

<tr>
<td class="text-right">03</td>
<td class="text-left">Evron Folkes</td>
<td class="text-left"><a href="https://dnsr03.dnslab.org">https://dnsr03.dnslab.org</a></td>
<td class="text-left">ssh user@dnsr03.dnslab.org</td>
<td class="text-left">zone03.dnslab.org</td>
</tr>

<tr>
<td class="text-right">04</td>
<td class="text-left">Zoltan Gegeny</td>
<td class="text-left"><a href="https://dnsr04.dnslab.org">https://dnsr04.dnslab.org</a></td>
<td class="text-left">ssh user@dnsr04.dnslab.org</td>
<td class="text-left">zone04.dnslab.org</td>
</tr>

<tr>
<td class="text-right">05</td>
<td class="text-left">(free)</td>
<td class="text-left"><a href="https://dnsr05.dnslab.org">https://dnsr05.dnslab.org</a></td>
<td class="text-left">ssh user@dnsr05.dnslab.org</td>
<td class="text-left">zone05.dnslab.org</td>
</tr>

<tr>
<td class="text-right">06</td>
<td class="text-left">(free)</td>
<td class="text-left"><a href="https://dnsr06.dnslab.org">https://dnsr06.dnslab.org</a></td>
<td class="text-left">ssh user@dnsr06.dnslab.org</td>
<td class="text-left">zone06.dnslab.org</td>
</tr>

<tr>
<td class="text-right">07</td>
<td class="text-left">Carsten Strotmann(Trainer)</td>
<td class="text-left">--</td>
<td class="text-left">--</td>
<td class="text-left">--</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> New terminology used in DNS &amp; BIND</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>The terms <code>master</code> and <code>slave</code> have been used to describe primary
and secondary authoritative DNS servers in the past.
<ul class="org-ul">
<li>However this terminology is wrong and misleading, for the
reasons discussed in the Internet Draft <i>Terminology, Power, and
Inclusive Language in Internet-Drafts and RFCs</i>:
<a href="https://tools.ietf.org/html/draft-knodel-terminology">https://tools.ietf.org/html/draft-knodel-terminology</a>
</li>
</ul>
</li>
<li>In this document, and in configuration examples, we are using the
new terms <code>primary</code> (instead of <code>master</code>) and <code>secondary</code> (instead
of <code>slave</code>) whenever possible.
</li>
<li>BIND 9 has stared adopting the new terms with BIND 9.14, however
the transition is not completed and some terms in configuration
statements are still using the old terms. This will change with
future releases
<ul class="org-ul">
<li>If you use an older version of BIND 9, please substitute the new
terms for the older ones
</li>
</ul>
</li>
<li>The old terminology will also be found in older books and
standards documents (RFCs and Internet Drafts)
</li>
<li>DNS terminology can be confusing and is sometimes overloaded. RFC
9499 <i>DNS terminology</i> ( <a href="https://tools.ietf.org/html/rfc9499">https://tools.ietf.org/html/rfc9499</a> )
tries to collect and document the current usage of DNS
terminology.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Building the authoritative DNS server</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Repeat the steps for the next chapter on the <code>nsNNa</code> and <code>nsNNb</code>
virtual machines (primary and secondary authoritative server)
</li>
</ul>
</div>
<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Enable ISC BIND 9 repository for Enterprise Linux 9</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Add the ISC BIND 9 repository to the packet-manager repository list
</li>
</ul>
<pre class="example">
% dnf copr enable isc/bind
</pre>
<ul class="org-ul">
<li>Install the EPEL (Extra Packages for Enterprise Linux) repository
(required for additional dependencies needed for BIND 9.20)
</li>
</ul>
<pre class="example">
% dnf install epel-release
</pre>
<p>
</div>
</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Installing BIND 9.20</h3>
<div class="outline-text-3" id="text-3-2">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Install BIND 9.20 from the ISC repositories
</li>
</ul>
<pre class="example">
% dnf install isc-bind
</pre>
<ul class="org-ul">
<li>ISC and EPEL signing keys
</li>
</ul>
<pre class="example">
Importing GPG key 0xC35B531D:
 Userid     : "isc_bind (None) &lt;isc#bind@copr.fedorahosted.org&gt;"
 Fingerprint: 490C 4AE6 3D8A 6B24 A641 2C8D ED4A 0B1B C35B 531D
 From       : https://download.copr.fedorainfracloud.org/results/isc/bind/pubkey.gpg

Importing GPG key 0x3228467C:
 Userid     : "Fedora (epel9) &lt;epel@fedoraproject.org&gt;"
 Fingerprint: FF8A D134 4597 106E CE81 3B91 8A38 72BF 3228 467C
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-9
</pre>
<ul class="org-ul">
<li>Quick reference for the <code>named</code> daemon:
<ul class="org-ul">
<li>The configuration file can be found at: <code>/etc/opt/isc/scls/isc-bind/named.conf</code>
</li>
<li>Command line options for the daemon can be specified in: <code>/etc/opt/isc/scls/isc-bind/sysconfig/named</code>
</li>
</ul>
</li>

<li>Note that due to the nature of Software Collections, no BIND 9
daemon or utility installed by these packages is available in $PATH
by default. To be able to use them, do the following:
<ul class="org-ul">
<li>to enable the Software Collection for the current shell, run <code>scl
     enable isc-bind bash</code>
</li>
<li>to enable the Software Collection inside a shell script, add the
following line to it: <code>source scl_source enable isc-bind</code>
</li>
</ul>
</li>
</ul>
<pre class="example">
% source scl_source enable isc-bind
% which named
/opt/isc/isc-bind/root/usr/sbin/named
</pre>
<ul class="org-ul">
<li>Add BIND 9 SCL path to bash shell startup
</li>
</ul>
<pre class="example">
% echo "source scl_source enable isc-bind" &gt;&gt; .bashrc
</pre>
<ul class="org-ul">
<li>Link the ISC BIND configuration file directory into the <code>/etc</code> directory (for easy access)
</li>
</ul>
<pre class="example">
% ln -s /etc/opt/isc/scls/isc-bind /etc
</pre>
<ul class="org-ul">
<li>Enable and start BIND 9
</li>
</ul>
<pre class="example">
% systemctl enable --now isc-bind-named
</pre>
<ul class="org-ul">
<li>Check that BIND 9 is running without errors
</li>
</ul>
<pre class="example">
% rndc status
% systemctl status isc-bind-named
</pre>
<p>
</div>
</p>
</div>
<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> A configuration file for an authoritative BIND 9 server</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Let's tweak the configuration file <code>/etc/isc-bind/named.conf</code> for an
authoritative-only DNS server
</li>
</ul>
<pre class="example">
options {
        directory "/var/named";
        listen-on { any; };
        listen-on-v6 { any; };
        dnssec-validation no;
        recursion no;
        minimal-responses yes;
        minimal-any yes;
        querylog no;
        max-udp-size 1232;
        edns-udp-size 1232;
        zone-statistics yes;
};
</pre>
<ul class="org-ul">
<li>Logging for the authoritative server
</li>
</ul>
<pre class="example">
logging {
        channel default_syslog {
          // Send most of the named messages to syslog.
          syslog local2;
          severity debug;
        };
        channel xfer {
          file "transfer.log" versions 10 size 10M;
          print-time yes;
        };
        channel update {
          file "update.log" versions 10 size 10M;
          print-time yes;
        };
        channel named {
          file "named.log" versions 10 size 20M;
          print-time yes;
          print-category yes;
        };
        channel security {
          file "security.log" versions 10 size 20M;
          print-time yes;
        };
        channel dnssec {
          file "dnssec.log" versions 10 size 20M;
          print-time yes;
        };
        channel ratelimit {
          file "ratelimit.log" versions 10 size 20M;
          print-time yes;
	      };
        channel query_log {
          file "query.log" versions 10 size 20M;
          severity debug;
          print-time yes;
        };
        channel query-error {
          file "query-errors.log" versions 10 size 20M;
          severity info;
          print-time yes;
        };

        category default        { default_syslog;  named; };
        category general        { default_syslog;  named; };
        category security       { security; };
        category queries        { query_log; };
        category dnssec         { dnssec; };
        category edns-disabled  { default_syslog; };
        category config         { default_syslog; named; };
        category xfer-in        { default_syslog; xfer; };
        category xfer-out       { default_syslog; xfer; };
        category notify         { default_syslog; xfer; };
        category client         { default_syslog; named; };
        category network        { default_syslog; named; };
        category rate-limit     { ratelimit; };
	category update         { update; };
};
</pre>
<ul class="org-ul">
<li>Test the configuration
</li>
</ul>
<pre class="example">
% named-checkconf
</pre>
<ul class="org-ul">
<li>Reload the BIND 9 configuration
</li>
</ul>
<pre class="example">
% rndc reconfig
</pre>
<ul class="org-ul">
<li>The last two commands might fail. Why? What can you do to fix the issue?
</li>
<li>Open port 53 (DNS) in the firewall
</li>
</ul>
<pre class="example">
% firewall-cmd --permanent --zone=public --add-service=dns
% firewall-cmd --reload
</pre>
<ul class="org-ul">
<li>Test if you can reach your new authoritative server from the DNS resolver
<ul class="org-ul">
<li>from the resolver machine (<code>NN</code> = your number)
</li>
</ul>
</li>
</ul>
<pre class="example">
$ dig @nsNNa.dnslab.org ch TXT version.bind
</pre>
<p>
</div>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Solution "Building an authoritative DNS Server":</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>Issue: The <code>/var/named</code> directory is missing and needs to be owned
by the <code>named</code> user.
</li>
<li>Create the <code>/var/named</code> directory
</li>
</ul>
<pre class="example">
% mkdir /var/named
</pre>
<ul class="org-ul">
<li>Adjust the permissions on the BIND 9 home directory
</li>
</ul>
<pre class="example">
% chown named: /var/named
</pre>
<ul class="org-ul">
<li>The BIND 9 process should now successfully load the new
configuration
</li>
</ul>
<pre class="example">
% rndc reconfig
</pre>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Create a primary zone</h3>
<div class="outline-text-3" id="text-3-4">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Work on the primary DNS server <code>nsNNa</code>
</li>
<li>Goal: a working primary zone for this training lab environment
</li>
<li>The trainer will publish the solution after some time into the
exercise, but first try to create the configuration without
outside help
</li>
</ul>
<p>
</div>
</p>
</div>
<div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> A zone file</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Create a new zone file for the zone <code>zoneNN.dnslab.org</code> in the BIND 9
home directory <code>/var/named</code>
</li>
<li>The zone records should have a TTL of 60 seconds (not recommended
for production, but required for the course labs)
</li>
<li>The zone should contain: 1 x SOA, 2 x NS records (for <code>nsNNa</code> and
<code>nsNNb</code>)
</li>
<li>One A record for the name <code>primary.zoneNN.dnslab.org</code> (IPv4 of <code>nsNNa</code>)
</li>
<li>One AAAA record for the name <code>primary.zoneNN.dnslab.org</code> (IPv6 of <code>nsNNa</code>)
</li>
<li>One A record for the name <code>secondary.zoneNN.dnslab.org</code> (IPv4 of <code>nsNNb</code>)
</li>
<li>One AAAA record for the name <code>secondary.zoneNN.dnslab.org</code> (IPv6 of <code>nsNNb</code>)
</li>
<li>A TXT record with the owner-name of <code>text</code> and a text of your
choice
</li>
<li>Two MX records for <code>primary</code> and <code>secondary</code> with different
preference values
</li>
<li>Check the syntax of your zone-file with <code>named-checkzone</code>
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
<div id="outline-container-sec-3-4-2" class="outline-4">
<h4 id="sec-3-4-2"><span class="section-number-4">3.4.2</span> Register the zone in the BIND 9 configuration</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Create a zone block in <code>named.conf</code> for a primary zone for the zone
created in the last chapter
</li>
<li>Test the configuration with <code>named-checkconf -z</code>
</li>
<li>Reload the BIND 9 configuration
</li>
<li>Verify that <code>nsNNa.dnslab.org</code> answers authoritatively for this zone
(AA-Flag!)
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
<div id="outline-container-sec-3-4-3" class="outline-4">
<h4 id="sec-3-4-3"><span class="section-number-4">3.4.3</span> Solution for primary zone</h4>
<div class="outline-text-4" id="text-3-4-3">
<ul class="org-ul">
<li>The Zonefile (your zone will have different IPv4 and IPv6 addresses)
</li>
</ul>
<pre class="example">
$TTL 60
@          IN SOA       nsNNa.dnslab.org. hostmaster.zoneNN.dnslab.org. 1001 1h 30m 41d 30
           IN NS        nsNNa.dnslab.org.
           IN NS        nsNNb.dnslab.org.
           IN MX        10 primary
           IN MX        20 secondary
primary    IN A         192.0.2.53
           IN AAAA      2001:db8:100::53
secondary  IN A         192.0.2.153
           IN AAAA      2001:db8:200::53
text       IN TXT       "DNS Leap Ahead!"
</pre>
<ul class="org-ul">
<li>The primary zone configuration on <code>nsNNa</code>
</li>
</ul>
<pre class="example">
zone "zoneNN.dnslab.org" {
    type primary;
    file "zoneNN.dnslab.org";
};
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Register the zone on a secondary server</h3>
<div class="outline-text-3" id="text-3-5">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Work on the secondary DNS server <code>nsNNb</code>
</li>
<li>Goal: a working secondary zone for this course
</li>
<li>The trainer will publish the solution after some time into the
exercise, but first try to create the configuration without
outside help
</li>
<li>Create a zone block in <code>named.conf</code> on the secondary server to
load the zone <code>zoneNN.dnslab.org</code> from the primary server via zone
transfer
</li>
<li>Check the configuration with <code>named-checkconf -z</code>
</li>
<li>Reload the BIND 9 configuration
</li>
<li>Check the log files for errors
</li>
<li>Check the file <code>transfer.log</code> for successful transfer of the zone
<ul class="org-ul">
<li>The transfer fails &#x2013; why? How to solve this issue?
</li>
</ul>
</li>
<li>Verify that <code>nsNNb.dnslab.org</code> answers authoritatively for this zone
(AA-Flag!)
</li>
<li>Verify the delegation of your DNS servers with
<pre class="example">
dig zoneNN.dnslab.org +nssearch
</pre>
</li>
</ul>
<p>
</div>
</p>
</div>
<div id="outline-container-sec-3-5-1" class="outline-4">
<h4 id="sec-3-5-1"><span class="section-number-4">3.5.1</span> Solution for secondary zone</h4>
<div class="outline-text-4" id="text-3-5-1">
<ul class="org-ul">
<li>Starting with BIND 9.20.0, outgoing zone transfers are no longer
enabled by default. An explicit <code>allow-transfer ACL</code> must now be set
at the zone, view, or options level to enable outgoing transfers.
<ul class="org-ul">
<li>Here we use a simple "allow all" ACL (restoring the old,
pre-BIND-9.20 behavior. We will learn later in the course how to
secure zone transfer with cryptographic keys (TSIG).
</li>
</ul>
</li>
<li>The primary zone on <code>nsNNa</code>
</li>
</ul>
<pre class="example">
zone "zoneNN.dnslab.org" {
    type primary;
    file "zoneNN.dnslab.org";
    allow-transfer { any; };
};
</pre>

<ul class="org-ul">
<li>The secondary zone on <code>nsNNb</code>
</li>
</ul>
<pre class="example">
zone "zoneNN.dnslab.org" {
    type secondary;
    primaries { &lt;ipv6-address-of-primary&gt;; &lt;ipv4-address-of-primary&gt;; };
    file "zoneNN.dnslab.org";
};
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> A quick look at DNSSEC</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> DNS Security (or lack of)</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>the classic DNS from 1983 has not been designed with security in mind
</li>
<li>Attack vector: DNS cache poisoning  <img src="./img/0205-dns-dangers.png" class="img-responsive" alt="0205-dns-dangers.png">
</li>
<li>Attack vector: Men-in-the-Middle data spoofing <img src="./img/0206-dns-dangers.png" class="img-responsive" alt="0206-dns-dangers.png">
</li>
<li>Attack vector: changes to the client DNS resolver configuration <img src="./img/0207-dns-dangers.png" class="img-responsive" alt="0207-dns-dangers.png">
</li>
<li>Attacks of authoritative DNS servers  <img src="./img/0208-dns-dangers.png" class="img-responsive" alt="0208-dns-dangers.png">
</li>
<li>DNSSEC can help  <img src="./img/0210-roadsign.png" class="img-responsive" alt="0210-roadsign.png">
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> DNSSEC</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>the DNS security extension DNSSEC secures DNS data by augmenting
the data with cryptographic signatures
<ul class="org-ul">
<li>the owner (administrator) creates a pair of private and
public keys for each DNS zone (asymmetric crypto)
</li>
<li>the owner/administrator signs all DNS data with the
private/secret key
</li>
<li>the recipient of the data (DNS resolver or client operating
system or application) will verify (validate) the data
<ul class="org-ul">
<li>that the data has not been changed on the server nor during
transit
</li>
<li>that the data comes from the owner (the owner of the
private key)
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> The chain of trust in DNS</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>DNSSEC creates a chain of trust between the parent zone and the
child zone
</li>
</ul>

<figure>
<p><img src="./img/0209-DNSSEC-chain-of-trust.png" class="img-responsive" alt="0209-DNSSEC-chain-of-trust.png">
</p>
</figure>
<ul class="org-ul">
<li>Applications and DNS resolvers can follow the chain of trust to a
configured trust anchor to validate the DNS data
</li>
<li>We will look into DNSSEC in more details later in this course
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> DNSSEC in a nutshell</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>In DNSSEC, each zone has one or more key pairs.
<ul class="org-ul">
<li>The private key of each pair
<ul class="org-ul">
<li>Is stored securely (probably on a hidden primary)
</li>
<li>Is used to sign zone data
</li>
<li>Should never be stored in a RR
</li>
</ul>
</li>
<li>The public key of each pair
<ul class="org-ul">
<li>Is stored in the zone data, as a DNSKEY record
</li>
<li>Is used to verify zone data
</li>
</ul>
</li>
</ul>
</li>

<li>A private key signs the hashes of each RRSet in a zone.
</li>
<li>The public key is accessible through a standard RR.
<ul class="org-ul">
<li>Recursive servers or clients query for the public key RR in order to verify a hash.
</li>
<li>The RR is known as the DNSKEY and covered below.
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> DNSSEC key algorithms</h3>
<div class="outline-text-3" id="text-5-1">
<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="right">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="text-left">Algorithm</th>
<th scope="col" class="text-right">No.</th>
<th scope="col" class="text-left">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="text-left">RSAMD5</td>
<td class="text-right">1</td>
<td class="text-left">deprecated, not implemented</td>
</tr>

<tr>
<td class="text-left"><del>RSASHA1</del></td>
<td class="text-right">5</td>
<td class="text-left">not recommended, implemented (removed in <img src="img/bind-9-16-badge.png">)</td>
</tr>

<tr>
<td class="text-left">RSASHA256</td>
<td class="text-right">8</td>
<td class="text-left">recommended</td>
</tr>

<tr>
<td class="text-left">RSASHA512</td>
<td class="text-right">10</td>
<td class="text-left">large keys</td>
</tr>

<tr>
<td class="text-left"><del>DSA</del></td>
<td class="text-right">3</td>
<td class="text-left">slow validation, no extra security (removed in <img src="img/bind-9-16-badge.png">)</td>
</tr>

<tr>
<td class="text-left"><del>ECC-GOST</del></td>
<td class="text-right">12</td>
<td class="text-left">removed in BIND 9.18</td>
</tr>

<tr>
<td class="text-left">ECDSA</td>
<td class="text-right">13/14</td>
<td class="text-left">small signatures, read ECDSA and DNSSEC: <a href="http://blog.apnic.net/2014/10/23/ecdsa-and-dnssec/">http://blog.apnic.net/2014/10/23/ecdsa-and-dnssec/</a></td>
</tr>

<tr>
<td class="text-left">ED448/ED25519</td>
<td class="text-right">16/15</td>
<td class="text-left">new, not widely supported <a href="https://tools.ietf.org/html/rfc8080">RFC 8080</a> / <a href="https://tools.ietf.org/html/rfc8032">RFC 8032 Edwards-Curve Digital Signature Algorithm (EdDSA)</a></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> DNSSEC records</h3>
<div class="outline-text-3" id="text-5-2">
</div><div id="outline-container-sec-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> RRSIG</h4>
<div class="outline-text-4" id="text-5-2-1">
<ul class="org-ul">
<li>The RRSIG records holds the cryptographic signature over the DNS
data. The first field of the RRSIG holds the type this RRSIG is
for. Together with the domain name of the RRSIG this data is
important to match the signature to the data record.
</li>
<li>A zone's private key signs the RRSets in the zone.
<ul class="org-ul">
<li>The signatures are added to the zone as RRSIG RRs.
</li>
<li>If two key pairs are in use, each RRSet is signed twice, and
there is double the number of signatures.
</li>
</ul>
</li>
<li>Signatures have start and expiration times (typically a month or more apart).
<ul class="org-ul">
<li>They must be replaced before expiring. BIND 9 can automate the
signature updates.
</li>
<li>Keys don't have expiration timers.
</li>
</ul>
</li>
</ul>

<p>
<img id="RRSIG-record" class="img-responsive" src="img/RRSIG-record-00.png"></ p><input type="button" onclick="NextPage('RRSIG-record','9')" value=">" /><input type="button" onclick="ResetSlides('RRSIG-record')" value="O" /><input type="button" onclick="PrevPage('RRSIG-record')" value="<" />
</p>

<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Work on the DNS resolver machine
</li>
<li>Ask for the DNSSEC signature of <code>dnssec.works NS</code>:
</li>
</ul>
<pre class="example">
$ dig dnssec.works NS +dnssec +multi
</pre>
<ul class="org-ul">
<li>Answer these questions into the chat
<ul class="org-ul">
<li>Which algorithm is this zone using? check the number against
<a href="https://www.iana.org/assignments/dns-sec-alg-numbers/dns-sec-alg-numbers.xhtml">IANA Domain Name System Security (DNSSEC) Algorithm Numbers</a>
</li>
<li>When does the signature expire?
</li>
<li>When did the signature become valid?
</li>
</ul>
</li>
</ul>
<p>
</div>
</p>
</div>
</div>

<div id="outline-container-sec-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> DNSKEY</h4>
<div class="outline-text-4" id="text-5-2-2">
<ul class="org-ul">
<li>The public key of a DNSSEC key pair is stored in an DNSKEY RR.
<ul class="org-ul">
<li>The private key is not publicly available or accessible through DNS.
</li>
</ul>
</li>
<li>DNSKEY RRs are stored in the zone they can verify.
<ul class="org-ul">
<li>This conveniently means the zone administrator can sign all the
RRSets and create the DNSKEY RRSet.
</li>
</ul>
</li>
</ul>

<p>
<img id="DNSKEY-record" class="img-responsive" src="img/DNSKEY-record-00.png"></ p><input type="button" onclick="NextPage('DNSKEY-record','4')" value=">" /><input type="button" onclick="ResetSlides('DNSKEY-record')" value="O" /><input type="button" onclick="PrevPage('DNSKEY-record')" value="<" />
</p>

<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Work on the DNS resolver machine
</li>
<li>Ask for the DNSSEC keys of <code>dnsworkshop.cz</code>:
</li>
</ul>
<pre class="example">
$ dig dnsworkshop.cz DNSKEY +dnssec +multi
</pre>
<ul class="org-ul">
<li>Answer these questions into the chat
<ul class="org-ul">
<li>Which algorithm is this zone using?
</li>
<li>Compare the size of keys and signature with the zone
<code>dnssec.works</code>
</li>
<li>Write in the chat the sizes of both DNS answer messages as
reported by <code>dig</code>
</li>
</ul>
</li>
</ul>
<p>
</div>
</p>
</div>
</div>

<div id="outline-container-sec-5-2-3" class="outline-4">
<h4 id="sec-5-2-3"><span class="section-number-4">5.2.3</span> DS Record</h4>
<div class="outline-text-4" id="text-5-2-3">
<ul class="org-ul">
<li>The Delegation Signer (DS) records holds the hash of the
Key-Signing-Key of a DNSSEC signed child zone.
<ul class="org-ul">
<li>It is used to verify that the KSK has not been replaced without
permission
</li>
<li>The DS record is usually submitted to the parent zone operator
via a web-based or API system implemented by the domain reseller
(registrar)
<ul class="org-ul">
<li>This interface can become a target for attacker that want to
change data in a DNSSEC signed zone and should be protected
(two factor signon, registry lock etc).
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
<img id="DS-record" class="img-responsive" src="img/DS-record-00.png"></ p><input type="button" onclick="NextPage('DS-record','4')" value=">" /><input type="button" onclick="ResetSlides('DS-record')" value="O" /><input type="button" onclick="PrevPage('DS-record')" value="<" />
</p>

<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Work on the DNS resolver machine
</li>
<li>Ask for the DNSSEC delegation signer of <code>isc.org</code>:
</li>
</ul>
<pre class="example">
$ dig isc.org DS +dnssec +multi
</pre>
<ul class="org-ul">
<li>Answer these questions into the chat
<ul class="org-ul">
<li>Which algorithm is this zone using?
</li>
<li>What is the current key-id of the KSK in the zone <code>isc.org</code>?
</li>
<li>What hashing algorithm is used for the DS record of <code>isc.org</code>
<a href="https://www.iana.org/assignments/ds-rr-types/ds-rr-types.xhtml">check against Delegation Signer (DS) Resource Record (RR) Type Digest Algorithms</a>?
</li>
</ul>
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> DNSSEC signing and validation</h2>
<div class="outline-text-2" id="text-6">
<p>
<img id="dnssec-complete" class="img-responsive" src="img/dnssec-complete-00.png"></ p><input type="button" onclick="NextPage('dnssec-complete','10')" value=">" /><input type="button" onclick="ResetSlides('dnssec-complete')" value="O" /><input type="button" onclick="PrevPage('dnssec-complete')" value="<" />
</p>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> DNSSEC validation (simplified)</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>When the validator gets an RRSIG in a response, it needs the DNSKEY, and DS RR to authenticate.
<ul class="org-ul">
<li>If validation fails, the signed RRs are discarded, and SERVFAIL error is returned to the client.
</li>
<li>If no appropriate trust anchor exists, the RRSIG is ignored.
</li>
<li>If the chain of trust is broken the signature is ignored.
</li>
</ul>
</li>
<li>The steps in the following animation are simplified.
<ul class="org-ul">
<li>It only shows validation using one key per zone (SSK/CSK).
</li>
<li>Commonly, a zone has  ZSK &amp; KSK, so there are additional steps.
</li>
</ul>
</li>
</ul>

<p>
<img id="DNSSEC-name-resolution" class="img-responsive" src="img/DNSSEC-name-resolution-00.png"></ p><input type="button" onclick="NextPage('DNSSEC-name-resolution','58')" value=">" /><input type="button" onclick="ResetSlides('DNSSEC-name-resolution')" value="O" /><input type="button" onclick="PrevPage('DNSSEC-name-resolution')" value="<" />
</p>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Building a validating DNS Resolver</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>Work in the DNS resolver VM <code>dnsrNN.dnslab.org</code>
</li>
</ul>
</div>
<div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Enable ISC BIND 9 repository for Enterprise Linux 9</h3>
<div class="outline-text-3" id="text-8-1">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Add the ISC BIND 9 repository to the packet-manager repository list
</li>
</ul>
<pre class="example">
% dnf copr enable isc/bind
</pre>
<ul class="org-ul">
<li>Install the EPEL (Extra Packages for Enterprise Linux) repository
(required for additional dependencies needed for BIND 9.20)
</li>
</ul>
<pre class="example">
% dnf install epel-release
</pre>
<p>
</div>
</p>
</div>
</div>
<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Installing BIND 9.20</h3>
<div class="outline-text-3" id="text-8-2">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Install BIND 9.20 from the ISC repositories
</li>
</ul>
<pre class="example">
% dnf install isc-bind
</pre>
<ul class="org-ul">
<li>ISC and EPEL signing keys
</li>
</ul>
<pre class="example">
Importing GPG key 0xC35B531D:
 Userid     : "isc_bind (None) &lt;isc#bind@copr.fedorahosted.org&gt;"
 Fingerprint: 490C 4AE6 3D8A 6B24 A641 2C8D ED4A 0B1B C35B 531D
 From       : https://download.copr.fedorainfracloud.org/results/isc/bind/pubkey.gpg

Importing GPG key 0x3228467C:
 Userid     : "Fedora (epel9) &lt;epel@fedoraproject.org&gt;"
 Fingerprint: FF8A D134 4597 106E CE81 3B91 8A38 72BF 3228 467C
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-9
</pre>
<ul class="org-ul">
<li>Quick reference for the <code>named</code> daemon:
<ul class="org-ul">
<li>The configuration file can be found at: <code>/etc/opt/isc/scls/isc-bind/named.conf</code>
</li>
<li>Command line options for the daemon can be specified in: <code>/etc/opt/isc/scls/isc-bind/sysconfig/named</code>
</li>
</ul>
</li>

<li>Note that due to the nature of Software Collections, no BIND 9
daemon or utility installed by these packages is available in $PATH
by default. To be able to use them, do the following:
<ul class="org-ul">
<li>to enable the Software Collection for the current shell, run <code>scl
     enable isc-bind bash</code>
</li>
<li>to enable the Software Collection inside a shell script, add the
following line to it: <code>source scl_source enable isc-bind</code>
</li>
</ul>
</li>
</ul>
<pre class="example">
% source scl_source enable isc-bind
% which named
/opt/isc/isc-bind/root/usr/sbin/named
</pre>
<ul class="org-ul">
<li>Add BIND 9 SCL path to bash shell startup
</li>
</ul>
<pre class="example">
% echo "source scl_source enable isc-bind" &gt;&gt; .bashrc
</pre>
<ul class="org-ul">
<li>Link the ISC BIND configuration file directory into the <code>/etc</code> directory (for easy access)
</li>
</ul>
<pre class="example">
% ln -s /etc/opt/isc/scls/isc-bind /etc
</pre>
<ul class="org-ul">
<li>Enable and start BIND 9
</li>
</ul>
<pre class="example">
% systemctl enable --now isc-bind-named
</pre>
<ul class="org-ul">
<li>Check that BIND 9 is running without errors
</li>
</ul>
<pre class="example">
% rndc status
% systemctl status isc-bind-named
</pre>
<ul class="org-ul">
<li>Check if our BIND 9 works as a DNS resolver
</li>
</ul>
<pre class="example">
$ dig @localhost google.com
</pre>
<ul class="org-ul">
<li>Repeat the last query again
</li>
<li>Please send the answer to this question to the chat:
<ul class="org-ul">
<li>What is the answer time for the 1st request?
</li>
<li>What is the answer time for the 2nd request?
</li>
<li>Guess what causes the difference?
</li>
</ul>
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> Optimizations to the default configuration</h3>
<div class="outline-text-3" id="text-8-3">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Use your virtual lab machine, <code>dnsrNN</code> (DNS Resolver)
</li>
<li>Let's tweak the configuration file <code>/etc/isc-bind/named.conf</code> for a
resolver DNS server
</li>
<li>Add the following new lines in the <code>options</code> block in the
<code>/etc/isc-bind/named.conf</code> file:
</li>
</ul>
<pre class="example">
options {
        [...]
        server-id none;
        version none;
        hostname none;
        recursive-clients 32768;
        tcp-clients 1024;
        max-clients-per-query 1024;
        fetches-per-zone 2048;
        fetches-per-server 4096;
        edns-udp-size 1232;
        max-udp-size 1232;
        minimal-responses yes;
        querylog no;
        max-cache-size 2147483648;
};
</pre>
<ul class="org-ul">
<li>The values above are for an ISP level DNS resolver. They should work
for a broad range of DNS resolver machines, from small to very
large.
</li>
<li>The new configuration statements:
<ul class="org-ul">
<li><code>dnssec-validation auto;</code> enables DNSSEC validation via the
builtin trust anchor for the Internet Root-Zone. If DNSSEC is
used in an closed private DNS system (not connected to the
Internet), dedicated DNSSEC trust anchor must be configured.
This setting is the default in <img src="img/bind-9-16-badge.png">
</li>
<li><b>server-id none</b>: disable returning the server's hostname on the
query <code>dig @ip-of-server ch TXT hostname.bind</code>
</li>
<li><b>version none</b>: disable returning the BIND 9 version number on
the query <code>dig @ip-of-server ch TXT version.bind</code>
</li>
<li><b>recursive-clients</b>: number of concurrent DNS queries over UDP
that are allowed from clients
</li>
<li><b>tcp-clients</b>: number of concurrent DNS queries over TCP that are
allowed from clients
</li>
<li><b>max-clients-per-query 1024</b>: rate-limiting - number of
concurrent clients that can request the same query
</li>
<li><b>fetches-per-zone</b>: rate-limiting - maximum number of concurrent
DNS queries inside one zone
</li>
<li><b>fetches-per-server</b>: rate-limiting - maximum number of
concurrent DNS queries towards one authoritative DNS server
</li>
<li><b>edns-udp-size</b>: maximum UDP answer size requested from
authoritative servers
</li>
<li><b>max-udp-size</b>: maximum UDP answer size when sending answers to
clients
</li>
<li><b>minimal-responses yes</b>: only fill the authority and additional
sections when necessary by the DNS protocol
</li>
<li><b>querylog no</b>: disable query logging on start/restart even if
configured. Query logging slows down the DNS resolver
</li>
<li><b>max-cache-size 2147483648</b>: use a maximum of 2GB for the DNS
cache. A larger cache often has a negative impact on the DNS
resolvers performance. If unsure, test with a performance benchmark.
</li>
</ul>
</li>
<li>Check the configuration with <code>named-checkconf</code> and reload the BIND 9 configuration with <code>rndc reconfig</code>
</li>
<li>Make sure that the DNS resolver still does resolve DNS names in the Internet
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> EDNS - Response Size Limits in DNS</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> The early years - 512byte is enough</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li>The original DNS protocol had a size limit for DNS messages over UDP of 512 bytes
<ul class="org-ul">
<li>The aim was to prevent fragmentation on the network path
<ul class="org-ul">
<li>esp. in the early days of TCP/IP, fragmentation was slow
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> RFC 1035</h3>
<div class="outline-text-3" id="text-9-2">
<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/rfc1035">RFC 1035</a> states in 2.3.4. Size limits:
<blockquote>
<p>
UDP messages    512 octets or less
</p>
</blockquote>
</li>
<li>and in section 4.2.1 UDP usage:
<blockquote>
<p>
Messages carried by UDP are restricted to 512 bytes (not counting
the IP or UDP headers).  Longer messages are truncated and the TC
bit is set in the header.
</p>
</blockquote>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> The 13 Root DNS Servers</h3>
<div class="outline-text-3" id="text-9-3">
<ul class="org-ul">
<li>One artifact of the size limit of the original DNS protocol is the
number of authoritative DNS servers for the root zone in the
Internet (aka Root-Server)
<ul class="org-ul">
<li>There are 13 logical Root-Servers (<code>a.root-servers.net</code> to
<code>m.root-servers.net</code>)
</li>
<li>This is because without IPv6 and without the later EDNS0, 13 DNS
names and IPv4 addresses fit nicely into the 512 byte limit
</li>
</ul>
</li>
<li>The thirteen names
</li>
</ul>
<pre class="example">
$ dig -4 @a.root-servers.net NS . +noedns +nodnssec

; &lt;&lt;&gt;&gt; DiG 9.16.7 &lt;&lt;&gt;&gt; -4 @a.root-servers.net ns . +noedns +nodnssec
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 19932
;; flags: qr aa rd; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 15
[...]
;; ANSWER SECTION:
.			518400	IN	NS	a.root-servers.net.
.			518400	IN	NS	b.root-servers.net.
.			518400	IN	NS	c.root-servers.net.
.			518400	IN	NS	d.root-servers.net.
.			518400	IN	NS	e.root-servers.net.
.			518400	IN	NS	f.root-servers.net.
.			518400	IN	NS	g.root-servers.net.
.			518400	IN	NS	h.root-servers.net.
.			518400	IN	NS	i.root-servers.net.
.			518400	IN	NS	j.root-servers.net.
.			518400	IN	NS	k.root-servers.net.
.			518400	IN	NS	l.root-servers.net.
.			518400	IN	NS	m.root-servers.net.
[...]
;; Query time: 37 msec
;; SERVER: 198.41.0.4#53(198.41.0.4)
;; WHEN: Mon Oct 26 10:14:30 CET 2020
;; MSG SIZE  rcvd: 492
</pre>
</div>
</div>
<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4"><span class="section-number-3">9.4</span> DNS over TCP</h3>
<div class="outline-text-3" id="text-9-4">
<ul class="org-ul">
<li>When a DNS server needs to send a DNS response message larger than
the UDP size limit, it will send an incomplete response with the TC
"<i>Truncated</i>" flag set in the DNS header
<ul class="org-ul">
<li>The DNS client (could be a DNS resolver), will detect the TC flag
and will repeat the query over TCP
<ul class="org-ul">
<li>There is no size limit on DNS responses over TCP
</li>
<li>But TCP is not as fast as UDP, so this should be avoided
</li>
</ul>
</li>
</ul>
</li>
<li>Because the DNS protocol can switch from UDP to TCP on larger
responses (&gt; 512 byte), DNS servers (authoritative as well as DNS
resolvers) should always support DNS over TCP
<ul class="org-ul">
<li>And the firewall should allow DNS port 53 on UDP and TCP
</li>
</ul>
</li>
</ul>
<pre class="example">
$ dig -4 larger.dnssec.works TXT +noedns
;; Truncated, retrying in TCP mode.

; &lt;&lt;&gt;&gt; DiG 9.16.7 &lt;&lt;&gt;&gt; -4 larger.dnssec.works txt +noedns
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 64327
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: 0
[...]
</pre>
</div>
</div>
<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5"><span class="section-number-3">9.5</span> New developments in DNS</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li>In the mid 1990ies, there was new development around the DNS protocol
<ul class="org-ul">
<li>DNS security (DNSSEC)
</li>
<li>Cryptographic Signatures (TSIG and SIG(0))
</li>
<li>IPv6 Resource records
</li>
<li>DNS as a distribution channel for cryptographic keys for applications
</li>
</ul>
</li>
<li>The 512byte limit was becoming a hindrance
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-6" class="outline-3">
<h3 id="sec-9-6"><span class="section-number-3">9.6</span> EDNS0</h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li>The IETF created an extension to DNS, called EDNS0
<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/rfc2671">RFC 2671 <i>Extension Mechanisms for DNS (EDNS0)</i></a> (1999-08) and <a href="https://tools.ietf.org/html/rfc6891">RFC 6891</a> (2013-04)
</li>
</ul>
</li>
<li>EDNS Version 0 (EDNS0) allows DNS messages sizes over UDP for up to
4096 bytes
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-7" class="outline-3">
<h3 id="sec-9-7"><span class="section-number-3">9.7</span> ENDS0 features</h3>
<div class="outline-text-3" id="text-9-7">
<ul class="org-ul">
<li>Besides lifting the limit on the maximum DNS response size, EDNS
allows for additional DNS flags and payload:
<ul class="org-ul">
<li>DNSSEC OK Flag (DO)
</li>
<li><a href="https://tools.ietf.org/html/rfc7314">RFC 7314 Expire Option</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7828">RFC 7828 TCP Keepalive Option</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7830">RFC 7830 Padding Option</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc7873">RFC 7873 DNS cookies</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc8145">RFC 8145 Signaling Trust Anchor Knowledge in DNSSEC</a>
</li>
<li><a href="https://tools.ietf.org/html/rfc8914">RFC 8914 Extended DNS errors</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-8" class="outline-3">
<h3 id="sec-9-8"><span class="section-number-3">9.8</span> EDNS1 (2,3,4 &#x2026;)</h3>
<div class="outline-text-3" id="text-9-8">
<ul class="org-ul">
<li>The current version of EDNS is version 0
<ul class="org-ul">
<li>There had been discussions in the IETF on newer EDNS versions
(such as EDNS1
<a href="https://datatracker.ietf.org/doc/draft-andrews-edns1/">https://datatracker.ietf.org/doc/draft-andrews-edns1/</a>)
</li>
<li>But so far no new EDNS version has been standardized
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> DNS resolver best practices</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Prevent DNS fragmentation</h3>
<div class="outline-text-3" id="text-10-1">
</div><div id="outline-container-sec-10-1-1" class="outline-4">
<h4 id="sec-10-1-1"><span class="section-number-4">10.1.1</span> IPv6 and DNS fragmentation</h4>
<div class="outline-text-4" id="text-10-1-1">
<ul class="org-ul">
<li>DNS originally had a 512B UDP payload limit.
</li>
<li>The limit was raised to 4096B with EDNS0, <a href="https://tools.ietf.org/html/rfc2671">RFC 2671 <i>Extension
Mechanisms for DNS (EDNS0)</i></a> (1999-08) and <a href="https://tools.ietf.org/html/rfc6891">RFC 6891</a> (2013-04).
</li>
<li>IPv6 fragmentation is broken
<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/rfc7872">RFC 7872: Observations on the Dropping of Packets with IPv6 Extension Headers in the Real World</a>
</li>
<li>IPv6 packets &gt; 1280B may fragment. That effects DNS responses
over UDP.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-1-2" class="outline-4">
<h4 id="sec-10-1-2"><span class="section-number-4">10.1.2</span> Cache Spoofing Attacks via DNS fragmentation</h4>
<div class="outline-text-4" id="text-10-1-2">
<ul class="org-ul">
<li>Attacker can use DNS fragmentation to plant wrong information inside a DNS Resolver cache
<ul class="org-ul">
<li>Without DNSSEC, all identify information is in the 1st fragment
</li>
<li>The attacker can spoof the 2nd fragment without anyone noticing
</li>
</ul>
</li>
</ul>

<p>
<img id="DNS-frag-spoofing" class="img-responsive" src="img/DNS-frag-spoofing-00.png"></ p><input type="button" onclick="NextPage('DNS-frag-spoofing','8')" value=">" /><input type="button" onclick="ResetSlides('DNS-frag-spoofing')" value="O" /><input type="button" onclick="PrevPage('DNS-frag-spoofing')" value="<" />
</p>
</div>
</div>
<div id="outline-container-sec-10-1-3" class="outline-4">
<h4 id="sec-10-1-3"><span class="section-number-4">10.1.3</span> Preventing fragmentation</h4>
<div class="outline-text-4" id="text-10-1-3">
<ul class="org-ul">
<li>Configure a maximum EDNS packet size of 1232 byte (1280 IPv6 MTU -
UDP header - IPv6 header)
<ul class="org-ul">
<li>This also works for IPv4 over Ethernet
</li>
<li>This is the new default in DNS software (BIND 9, Unbound etc)
since <a href="https://dnsflagday.net/2020/">DNS Flag-Day 2020</a> (October 2020)
</li>
</ul>
</li>
<li>Example for BIND 9 <code>named.conf</code>
</li>
</ul>
<pre class="example">
options {
  [...]
  max-udp-size 1232;
  edns-udp-size 1232;
};
</pre>
<ul class="org-ul">
<li><b>Important:</b> a DNS Resolver with this setting <b>must</b> support
DNS-over-TCP (Port 53) to the Internet
<ul class="org-ul">
<li>Make sure that outgoing connections on port 53/TCP (DNS) are not
blocked
</li>
</ul>
</li>
<li>Optional: to increase security, block all fragmented UDP traffic
towards the DNS resolver in a firewall
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> minimal responses and minimal any</h3>
<div class="outline-text-3" id="text-10-2">
</div><div id="outline-container-sec-10-2-1" class="outline-4">
<h4 id="sec-10-2-1"><span class="section-number-4">10.2.1</span> Minimal responses</h4>
<div class="outline-text-4" id="text-10-2-1">
<ul class="org-ul">
<li>RFC 1034 defines the additional section in an DNS answer as
<i>Carries RRs which may be helpful in using the RRs in the other sections.</i>
<ul class="org-ul">
<li>In the default configuration, BIND 9 tries to be very helpful,
sending additional information …
</li>
<li>… creating larger than needed DNS answer packets
</li>
<li>This is sometimes exploited by attackers in distributed denial of
service attacks


<figure>
<p><img src="./img/DNS-reflection-01.png" class="img-responsive" alt="DNS-reflection-01.png">
</p>
</figure>


<figure>
<p><img src="./img/DNS-reflection-02.png" class="img-responsive" alt="DNS-reflection-02.png">
</p>
</figure>


<figure>
<p><img src="./img/DNS-Additional-Section.png" class="img-responsive" alt="DNS-Additional-Section.png">
</p>
</figure>
</li>
</ul>
</li>

<li>Configure <i>"minimal-responses"</i> in BIND 9
</li>
</ul>
<pre class="example">
options {
    [...]
   minimal-responses yes;
};
</pre>

<ul class="org-ul">
<li>BIND 9 will only return the data required for the DNS protocol to
work
<ul class="org-ul">
<li>this reduces the <i>ammo</i> available to attackers


<figure>
<p><img src="./img/Minimal-Responses.png" class="img-responsive" alt="Minimal-Responses.png">
</p>
</figure>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-2-2" class="outline-4">
<h4 id="sec-10-2-2"><span class="section-number-4">10.2.2</span> Minimal ANY</h4>
<div class="outline-text-4" id="text-10-2-2">
<ul class="org-ul">
<li>A BIND 9 server getting a query with type ANY (QTYPE 255) will answer with all records matching the requested domain name and class
<ul class="org-ul">
<li>This can create large UDP DNS answer packets
<pre class="example">
;; QUESTION SECTION:
;menandmice.com.                        IN      ANY

;; ANSWER SECTION:
menandmice.com.         86400   IN      SOA     dns1.menandmice.com. hostmaster.menandmice.com. 2016052701 900 300 604800 900
menandmice.com.         3600    IN      TXT     "HhnTdT3K"
menandmice.com.         3600    IN      TXT     "MS=ms81797768"
menandmice.com.         3600    IN      TXT     "v=spf1  include:spf.protection.outlook.com a:smtp.menandmice.is a:support.menandmice.com a:otrs.menandmice.com a:imap2.skyrr.is a:mx.hysing.is ~all"
ns2.c.is.               84985   IN      A       213.176.143.102
dns1.menandmice.com.    171385  IN      A       217.151.171.7
dns2.menandmice.com.    171385  IN      A       217.151.171.21
dns3.menandmice.com.    171385  IN      A       45.79.153.125
[…]
;; Query time: 97 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Mon Aug 15 10:49:15 CEST 2016
;; MSG SIZE  rcvd: 719   &lt;-- DNS answer size
</pre>
</li>
</ul>
</li>
<li>Starting with BIND 9.11, BIND 9 can be configured to only return the first entry of an matching ANY query
<ul class="org-ul">
<li>this mitigates the problem without causing breakage of older software (qmail etc)
</li>
</ul>
</li>
</ul>
<pre class="example">
options {
        [...]
       minimal-any yes;
};
</pre>
<ul class="org-ul">
<li>Same query as before with minimal-any enabled (note the use of <code>+notcp</code>):
</li>
</ul>
<pre class="example">
$ dig menandmice.com ANY +notcp
; &lt;&lt;&gt;&gt; DiG 9.11.0b3 &lt;&lt;&gt;&gt; menandmice.com any
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 32396
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: f0a6921ce7023ebc646d789357b1837a0962c60d534b251e (good)
;; QUESTION SECTION:
;menandmice.com.                        IN      ANY

;; ANSWER SECTION:
menandmice.com.	   60   IN   AAAA   2a01:7e00::f03c:91ff:fe89:ed54

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Mon Aug 15 10:55:22 CEST 2016
;; MSG SIZE  rcvd: 123
</pre>
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Temporarily remove <code>minimal-responses</code> and <code>minimal-any</code> from the
configuration of <code>nsNNb</code> (secondary server), check the
configuration and reload the BIND 9 DNS server
</li>
<li>Query your zone <code>zoneNN.dnslab.org</code> from the primary server <code>nsNNa</code>
and from the secondary server <code>nsNNb</code>. Do you see a difference?
Write the size of the responses of both queries in the chat.
</li>
<li>Send the following query towards both authoritative servers: write
the size of the responses to the chat
<pre class="example">
dig @nsNNa.dnslab.org zoneNN.dnslab.org ANY +notcp
dig @nsNNb.dnslab.org zoneNN.dnslab.org ANY +notcp
</pre>
</li>
<li>Re-enable  <code>minimal-responses</code> and <code>minimal-any</code> on <code>nsNNb</code>.
Verify with a <code>dig</code> command that these functions are now enabled
again.
</li>
</ul>

<p>
</div>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3"><span class="section-number-3">10.3</span> Empty Zones - Protecting the Internet from Useless Queries</h3>
<div class="outline-text-3" id="text-10-3">
</div><div id="outline-container-sec-10-3-1" class="outline-4">
<h4 id="sec-10-3-1"><span class="section-number-4">10.3.1</span> RFC 1918</h4>
<div class="outline-text-4" id="text-10-3-1">
<ul class="org-ul">
<li>RFC 1918 defines private address space that should not be routed on the Internet.

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="text-left">Network</th>
<th scope="col" class="text-left">Size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="text-left">10.0.0.0 - 10.255.255.255</td>
<td class="text-left">(10/8 prefix)</td>
</tr>

<tr>
<td class="text-left">172.16.0.0 - 172.31.255.255</td>
<td class="text-left">(172.16/12 prefix)</td>
</tr>

<tr>
<td class="text-left">192.168.0.0 - 192.168.255.255</td>
<td class="text-left">(192.168/16 prefix)</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-10-3-2" class="outline-4">
<h4 id="sec-10-3-2"><span class="section-number-4">10.3.2</span> RFC 6890, RFC 8190</h4>
<div class="outline-text-4" id="text-10-3-2">
<ul class="org-ul">
<li>There are network blocks, beyond those from RFC 1918, that also
shouldn't be routed on the Internet.
<ul class="org-ul">
<li>IPv4 APIPA
</li>
<li>IPv6 Unique Local Addresses
</li>
<li>Documentation addresses
</li>
</ul>
</li>
<li>All such address blocks are collected in <a href="https://tools.ietf.org/html/rfc6890">RFC 6890: Special-Purpose
IP Address Registries</a> (2013-04) with updates in <a href="https://tools.ietf.org/html/rfc8190">RFC 8190 - Updates
to the Special-Purpose IP Address Registries</a> (2017-06)
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3-3" class="outline-4">
<h4 id="sec-10-3-3"><span class="section-number-4">10.3.3</span> Useless Traffic &amp; Useless Queries</h4>
<div class="outline-text-4" id="text-10-3-3">
<ul class="org-ul">
<li>Packets on the Internet with a non-routeable address cause issues.
<ul class="org-ul">
<li>Organizations should prevent such packets from leaving their networks.
</li>
</ul>
</li>
<li><b>Likewise, unanswerable DNS queries cause issues and should not be allowed to reach the Internet.</b>
<ul class="org-ul">
<li>Not all useless queries are for reverse name space (PTRs), but the problem is universal for reverse space.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3-4" class="outline-4">
<h4 id="sec-10-3-4"><span class="section-number-4">10.3.4</span> Automatic Empty Zones</h4>
<div class="outline-text-4" id="text-10-3-4">
<ul class="org-ul">
<li>BIND 9.16 creates 100 empty zones for reverse name spaces.
<ul class="org-ul">
<li>The domains are in the <code>in-addr.arpa</code> and <code>ipv6.arpa</code>.
</li>
<li>The zones are not created if recursion is disabled.

<ul class="org-ul">
<li>RFC 1918: Address Allocation for Private Internets
</li>
<li>RFC 4193: Unique Local IPv6 Unicast Addresses
</li>
<li>RFC 5737: IPv4 Address Blocks Reserved for Documentation
</li>
<li>RFC 6598: IANA-Reserved IPv4 Prefix for Shared Address Space
</li>
<li>IPv6 local address (locally assigned)
</li>
<li>IPv6 link local addresses
</li>
<li>IPv6 loopback address
</li>
<li>the IPv6 unknown address

<pre class="example">
12-Oct-2020 06:48:27.002 automatic empty zone: 10.IN-ADDR.ARPA
12-Oct-2020 06:48:27.002 automatic empty zone: 16.172.IN-ADDR.ARPA
12-Oct-2020 06:48:27.002 automatic empty zone: 17.172.IN-ADDR.ARPA
12-Oct-2020 06:48:27.002 automatic empty zone: 18.172.IN-ADDR.ARPA
...
</pre>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="text-left">Network/Prefix</th>
<th scope="col" class="text-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="text-left">127.in-addr.arpa.</td>
<td class="text-left">IPv4 loopback</td>
</tr>

<tr>
<td class="text-left">2.0.2.192.in-addr.arpa.</td>
<td class="text-left">IPv4 Documentation</td>
</tr>

<tr>
<td class="text-left">100.51.198.in-addr.arpa.</td>
<td class="text-left">IPv4 Documentation</td>
</tr>

<tr>
<td class="text-left">113.0.203.in-addr.arpa.</td>
<td class="text-left">IPv4 Documentation</td>
</tr>

<tr>
<td class="text-left">255.255.255.255.in-addr.arpa.</td>
<td class="text-left">IPv4 Broadcast</td>
</tr>

<tr>
<td class="text-left">0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.IP6.ARPA</td>
<td class="text-left">IPv6 unspecified address (::)</td>
</tr>

<tr>
<td class="text-left">D.F.ip6.arpa.</td>
<td class="text-left">Unique Local Address Block</td>
</tr>

<tr>
<td class="text-left">8.E.F.ip6.arpa.</td>
<td class="text-left">Link Local Addresses</td>
</tr>

<tr>
<td class="text-left">9.E.F.ip6.arpa.</td>
<td class="text-left">Link Local Addresses</td>
</tr>

<tr>
<td class="text-left">A.E.F.ip6.arpa.</td>
<td class="text-left">Link Local Addresses</td>
</tr>

<tr>
<td class="text-left">B.E.F.ip6.arpa.</td>
<td class="text-left">Link Local Addresses</td>
</tr>

<tr>
<td class="text-left">8.B.D.0.1.0.0.2.ip6.arpa.</td>
<td class="text-left">IPv6 Documentation Addresses</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</li>

<li>BIND 9.16 adds empty zones for <code>home.arpa</code> and
<code>empty.as112.arpa</code>:
<pre class="example">
12-Oct-2020 06:48:27.003 automatic empty zone: EMPTY.AS112.ARPA
12-Oct-2020 06:48:27.003 automatic empty zone: HOME.ARPA
</pre>
</li>
<li>BIND 9.20 adds empty zones for <code>resolver.arpa</code> (<a href="https://datatracker.ietf.org/doc/rfc9462/">RFC 9462 - Discovery of Designated Resolvers</a>)
<pre class="example">
Oct 29 08:32:16 dnsr07 named[2952]: automatic empty zone: RESOLVER.ARPA
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3-5" class="outline-4">
<h4 id="sec-10-3-5"><span class="section-number-4">10.3.5</span> Other Useless Queries</h4>
<div class="outline-text-4" id="text-10-3-5">
<ul class="org-ul">
<li>Other empty zones have to be manually configured.
<ul class="org-ul">
<li>Doing so improves Internet security!
</li>
<li>The root servers see a high percentage of useless queries (see below).
</li>
<li>These are for TLDs that aren't delegated.


<figure>
<p><img src="./img/Root-QTYPE-TLD.png" class="img-responsive" alt="Root-QTYPE-TLD.png">
</p>
</figure>

<p>
<a href="https://stats.dns.icann.org/stats/d/wom-ext-5minagg-qtype-vs-tld/qtype-vs-tld?orgId=1&amp;from=1602390637038&amp;to=1602473437038&amp;var-Server=IMRS&amp;var-Region=All&amp;var-Country=All&amp;var-City=All&amp;var-Instance=All&amp;theme=light">ICANN Stats: QTYPE for most popular Undelegated TLDs queried</a>
</p>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-10-3-6" class="outline-4">
<h4 id="sec-10-3-6"><span class="section-number-4">10.3.6</span> Stopping Useless Queries</h4>
<div class="outline-text-4" id="text-10-3-6">
<ul class="org-ul">
<li>Stop unanswerable queries by configuring the DNS resolver as
authoritative for unanswerable zones.
<ul class="org-ul">
<li>The zones are empty, so the server answers all queries with
<code>NXDOMAIN</code>.
</li>
<li>Empty zones are not a violation of the recommendation to keep
authoritative and recursive servers independent.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3-7" class="outline-4">
<h4 id="sec-10-3-7"><span class="section-number-4">10.3.7</span> Additional Empty Zones</h4>
<div class="outline-text-4" id="text-10-3-7">
<ul class="org-ul">
<li>These zones are not among the automatically empty in BIND, and should be configured as empty:
<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="text-left">Zone</th>
<th scope="col" class="text-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="text-left">local</td>
<td class="text-left">multicast DNS (Apple Bonjour, Avahi, systemd-sd)</td>
</tr>

<tr>
<td class="text-left">belkin</td>
<td class="text-left">used in Belkin network equipment</td>
</tr>

<tr>
<td class="text-left">home</td>
<td class="text-left">local TLD</td>
</tr>

<tr>
<td class="text-left">localdomain</td>
<td class="text-left">default local Domain used in Red Hat Linux</td>
</tr>

<tr>
<td class="text-left">lan</td>
<td class="text-left">local TLD, used in some CPE equipment</td>
</tr>

<tr>
<td class="text-left">corp</td>
<td class="text-left">local TLD</td>
</tr>

<tr>
<td class="text-left">domain</td>
<td class="text-left">local TLD</td>
</tr>

<tr>
<td class="text-left">internal</td>
<td class="text-left">local TLD</td>
</tr>

<tr>
<td class="text-left">dhcp</td>
<td class="text-left">local TLD</td>
</tr>

<tr>
<td class="text-left">localhost</td>
<td class="text-left">the "localhost" name</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3-8" class="outline-4">
<h4 id="sec-10-3-8"><span class="section-number-4">10.3.8</span> An Empty Zone File</h4>
<div class="outline-text-4" id="text-10-3-8">
<ul class="org-ul">
<li>Only MNAME (name-of-server) &amp; RNAME (contact-email / Responsible person) are of real interest.
</li>
<li>The SOA's TTL and the negative TTL, as well, but are likely to be generic.
<pre class="example">
@   10800   IN SOA &lt;name-of-server&gt;. &lt;contact-email&gt;. 1 3600 1200 604800 10800
@   10800   IN NS  &lt;name-of-server&gt;.
</pre>
</li>
<li>The empty zone is then used in <code>named.conf</code>.
<pre class="example">
zone "corp"   { type primary; file "empty-zone.db"; };
zone "local"  { type primary; file "empty-zone.db"; };
zone "belkin" { type primary; file "empty-zone.db"; };
[...]
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3-9" class="outline-4">
<h4 id="sec-10-3-9"><span class="section-number-4">10.3.9</span> Extra Empty Zones</h4>
<div class="outline-text-4" id="text-10-3-9">
<ul class="org-ul">
<li>Since BIND 9.5, empty zones can be configured in named.conf without a zone file.
<pre class="example">
zone "zonename" {
    type primary;
    database "_builtin empty &lt;nameserver&gt; &lt;contact&gt;";
};
</pre>
<ul class="org-ul">
<li><code>nameserver</code> = MNAME for SOA
</li>
<li><code>contact</code> = RNAME for SOA
</li>
</ul>
</li>
</ul>
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Work on the DNS resolver machine <code>dnsrNN</code>
</li>
<li>Clear the cache with <code>rndc flush</code>
</li>
<li>Test a query for a popular non-existing TLD against the local BIND
9 and write down the response time
</li>
</ul>
<pre class="example">
$ dig test.internal @localhost
</pre>
<ul class="org-ul">
<li>Add an empty zone for the TLD <code>internal</code> to the BIND 9
configuration in <code>named.conf</code>
</li>
<li>Check the configuration, reload the BIND 9 DNS server and test
again. What is the response time now. Write the delta into the chat.
</li>
</ul>
<p>
</div>
</p>
</div>
<ol class="org-ol"><li><a id="sec-10-3-9-1" name="sec-10-3-9-1"></a>Solution:<br ><div class="outline-text-5" id="text-10-3-9-1">
<ul class="org-ul">
<li>In <code>/etc/isc-bind/named.conf</code> (the "." at the end of the domain names are important!):
</li>
</ul>
<pre class="example">
zone "internal" {
    type primary;
    database "_builtin empty dnsr06.dnslab.org. hostmaster.dnslab.org.";
};
</pre>
</div>
</li></ol>
</div>
</div>
<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4"><span class="section-number-3">10.4</span> Prefetch</h3>
<div class="outline-text-3" id="text-10-4">
</div><div id="outline-container-sec-10-4-1" class="outline-4">
<h4 id="sec-10-4-1"><span class="section-number-4">10.4.1</span> Query Response Time</h4>
<div class="outline-text-4" id="text-10-4-1">
<ul class="org-ul">
<li>Quicker response time is a frequent goal of DNS deployment changes
and of new BIND versions.
</li>
<li>Prefetch makes recursive servers respond quicker for often queried
RRs.
<ul class="org-ul">
<li>Not all answers are quicker, but response times are more
uniformly quick.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-4-2" class="outline-4">
<h4 id="sec-10-4-2"><span class="section-number-4">10.4.2</span> Frequently Queried RRs</h4>
<div class="outline-text-4" id="text-10-4-2">
<ul class="org-ul">
<li>Consider a resolver that is queried for the same RR.
<ul class="org-ul">
<li>The first query takes long, because an authoritative server must
be queried.
</li>
<li>Subsequent queries are fast; answers are in the cache.
</li>
<li>The first query after the RRs TTL expires, takes longer, as an
authoritative server is again queried.
<ul class="org-ul">
<li>All queries arriving before the RR is re-cached, take longer.
</li>
<li>It is these queries that prefetch speeds up.
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-4-3" class="outline-4">
<h4 id="sec-10-4-3"><span class="section-number-4">10.4.3</span> Prefetch</h4>
<div class="outline-text-4" id="text-10-4-3">
<ul class="org-ul">
<li>Prefetch assures that frequent queries are consistently answered
from the cache.
</li>
<li>Prefetch was introduced in BIND version 9.10.
</li>
<li>Prefetch is configured in <code>options {}</code>, it cannot be set per zone.
<pre class="example">
options {
  [...]
  prefetch 8 59;
  [...]
};
</pre>
</li>
<li>The first number is the trigger (seconds).
</li>
<li>The second number is the eligibility (seconds).
</li>
<li>Prefetch is enabled by default in BIND 9.10+
<ul class="org-ul">
<li>Default trigger value: 2s.  Default eligibility value: 9s.
</li>
</ul>
</li>
<li>Set the trigger to 0s to disable prefetch.
<ul class="org-ul">
<li>The maximum trigger value is 10s.
</li>
</ul>
</li>
<li>Setting it higher is accepted, but will silently be 10s.
</li>
</ul>
</div>
<ol class="org-ol"><li><a id="sec-10-4-3-1" name="sec-10-4-3-1"></a>Prefetch Trigger<br ><div class="outline-text-5" id="text-10-4-3-1">
<pre class="example">
prefetch 8 59;
</pre>
<ul class="org-ul">
<li>A query arriving when the remaining TTL is under the trigger,
causes the server to re-query the RR.
</li>
<li>This has no effect on the query that triggers the prefetch.
</li>
<li>Subsequent queries benefit.
</li>
<li>For frequently queried RRs, answers will more consistently come
from the cache.
</li>
</ul>
</div>
</li>
<li><a id="sec-10-4-3-2" name="sec-10-4-3-2"></a>Prefetch Eligibility<br ><div class="outline-text-5" id="text-10-4-3-2">
<pre class="example">
prefetch 8 59;
</pre>
<ul class="org-ul">
<li>Only RRs with an initial TTL greater than the eligibility, can be
prefetched.
</li>
<li>In the example, a TTL of 60s or greater is eligible for prefetch.
</li>
<li>The eligibility must be at least 6s greater than the trigger, or it
will be silently increased.
</li>
</ul>
</div>
</li></ol>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> 'dig'ing deeper</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1"><span class="section-number-3">11.1</span> dig</h3>
<div class="outline-text-3" id="text-11-1">
<p>
dig's default output is divided into seven sections.
Not every section is shown with each dig command.
</p>
<ul class="org-ul">
<li>cmd (initial comment)
</li>
<li>comment
</li>
<li>question (the query)
</li>
<li>answer
</li>
<li>authority
</li>
<li>additional
</li>
<li>stats
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2"><span class="section-number-3">11.2</span> dig Query Options</h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>The sections are toggled to appear or be hidden with query options.
<ul class="org-ul">
<li>Query options begin with a <code>+</code>.
</li>
<li>All query options can be disabled with <code>+noall</code>, then individual
options can be re-enabled.
<pre class="example">
$ dig +noall server01.dnslab.org
</pre>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-3" class="outline-3">
<h3 id="sec-11-3"><span class="section-number-3">11.3</span> dig +[no]cmd</h3>
<div class="outline-text-3" id="text-11-3">
<ul class="org-ul">
<li>The initial comment (cmd) section shows the dig version number and query options.
<pre class="example">
$ dig +noall +cmd server01.dnslab.org
; &lt;&lt;&gt;&gt; DiG 9.10.3 &lt;&lt;&gt;&gt; server01.dnslab.org +noall +cmd
;; global options: +cmd
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-4" class="outline-3">
<h3 id="sec-11-4"><span class="section-number-3">11.4</span> dig +[no]stats</h3>
<div class="outline-text-3" id="text-11-4">
<ul class="org-ul">
<li><b>stats</b> is the last section displayed.
<ul class="org-ul">
<li>It shows the time for the query, the server queried, and the
total size of the response packet.
<pre class="example">
$ dig +noall server01.dnslab.org +stats
;; Query time: 7 msec
;; SERVER: 192.168.53.251#53(192.168.53.251)
;; WHEN: Wed Nov 25 12:55:36 UTC 2015
;; MSG SIZE  rcvd: 92
</pre>
</li>
</ul>
</li>
</ul>
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Run a <code>dig +noall +answer +stats menandmice.com</code>
What could be reasons for <code>dig</code> to output <code>SERVER</code> and a date/time stamp
in the output?
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
<div id="outline-container-sec-11-5" class="outline-3">
<h3 id="sec-11-5"><span class="section-number-3">11.5</span> dig +nocmd +nostats</h3>
<div class="outline-text-3" id="text-11-5">
<ul class="org-ul">
<li>The output of dig gets considerably smaller without the first and
last sections (initial comment &amp; stats).
<pre class="example">
$ dig +nocmd +nostats ns01a.dnslab.org
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 21736
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;ns01a.dnslab.org.                        IN      A

;; ANSWER SECTION:
ns01a.dnslab.org.         60      IN      A       178.128.233.110
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-11-6" class="outline-3">
<h3 id="sec-11-6"><span class="section-number-3">11.6</span> dig +comment</h3>
<div class="outline-text-3" id="text-11-6">
<ul class="org-ul">
<li>The comment section comes after the cmd (initial comment) section.
<ul class="org-ul">
<li>It shows all message fields except the four with RRs.
</li>
<li>RCODE is listed as status.
<pre class="example">
$ dig +noall  server01.dnslab.org +comment
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 42739
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
</pre>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-7" class="outline-3">
<h3 id="sec-11-7"><span class="section-number-3">11.7</span> dig +comment</h3>
<div class="outline-text-3" id="text-11-7">
<ul class="org-ul">
<li>The option <code>+nocomment</code> removes the <b>comments</b> section, and comments
before other sections.
<pre class="example">
$ dig +nocmd +nostats ns01a.dnslab.org | grep SECTION
;; OPT PSEUDOSECTION:
;; QUESTION SECTION:
;; ANSWER SECTION:

$ dig +nocmd +nostats  ns01a.dnslab.org +nocomment | grep SECTION
$
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-8" class="outline-3">
<h3 id="sec-11-8"><span class="section-number-3">11.8</span> dig +question</h3>
<div class="outline-text-3" id="text-11-8">
<ul class="org-ul">
<li>The <b>question</b> section shows the query as it appears in the response message.
<pre class="example">
$ dig +noall +question ns01a.dnslab.org
;ns01a.dnslab.org.                        IN      A
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-9" class="outline-3">
<h3 id="sec-11-9"><span class="section-number-3">11.9</span> dig +answer</h3>
<div class="outline-text-3" id="text-11-9">
<ul class="org-ul">
<li>The <b>answer</b> section shows the query response in standard Master
File Format.
<pre class="example">
$ dig +noall +answer ns01a.dnslab.org
ns01a.dnslab.org.         36      IN      A       178.128.233.110
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-10" class="outline-3">
<h3 id="sec-11-10"><span class="section-number-3">11.10</span> dig +authority</h3>
<div class="outline-text-3" id="text-11-10">
<ul class="org-ul">
<li>The <b>authority</b> section shows the authority section in the query
response.
<pre class="example">
$ dig +noall +authority ns01a.zone100.dnslab.org @localhost
zone100.dnslab.org.        30      IN      SOA     ns01a.dnslab.org. hostmaster.zone100.dnslab.org. 1001 3600 1800 3542400 30
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-11" class="outline-3">
<h3 id="sec-11-11"><span class="section-number-3">11.11</span> dig +additional</h3>
<div class="outline-text-3" id="text-11-11">
<ul class="org-ul">
<li>The <b>additional</b> section shows the additional section in the query response.
</li>
<li>The <code>OPT</code> pseudo-header for EDNS is sent in the additional section,
but not displayed there by dig.
<ul class="org-ul">
<li>It is in the comments section.
<pre class="example">
$ dig +noall +additional  ns01a.dnslab.org
$
</pre>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-12" class="outline-3">
<h3 id="sec-11-12"><span class="section-number-3">11.12</span> dig +qr</h3>
<div class="outline-text-3" id="text-11-12">
<ul class="org-ul">
<li>By default, <code>dig</code> shows the response message.
<ul class="org-ul">
<li>The <code>+qr</code> option adds the outgoing query.
</li>
<li>The query is shown after the text: <code>"Sending:"</code>
<pre class="example">
$ dig +qr ns01a.dnslab.org
; &lt;&lt;&gt;&gt; DiG 9.11.13-RedHat-9.11.13-6.el8_2.1 &lt;&lt;&gt;&gt; +qr ns01a.dnslab.org
;; global options: +cmd
;; Sending:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 57808
;; flags: rd ad; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 7c29201b7c89b54e
;; QUESTION SECTION:
;ns01a.dnslab.org.                        IN      A

;; QUERY SIZE: 55

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 57808
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
&lt;OUTPUT SUPPRESSED&gt;
</pre>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-13" class="outline-3">
<h3 id="sec-11-13"><span class="section-number-3">11.13</span> dig +short</h3>
<div class="outline-text-3" id="text-11-13">
<ul class="org-ul">
<li><code>+short</code> disables the default output. It shows only the response's RDATA.
<ul class="org-ul">
<li>Contrast <code>+short</code>, to <code>+answer</code>, which displays the entire RRSet.
<pre class="example">
$ dig +short ns01a.dnslab.org
192.168.53.101

$ dig +noall +answer ns01a.dnslab.org
ns01a.dnslab.org.         30      IN      A       192.168.53.101
</pre>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-14" class="outline-3">
<h3 id="sec-11-14"><span class="section-number-3">11.14</span> Truncate &amp; dig +ignore</h3>
<div class="outline-text-3" id="text-11-14">
<ul class="org-ul">
<li>The response displayed by <code>dig</code> is the last received.
<ul class="org-ul">
<li>If a message returns with <code>tc</code> set, the query is resent with TCP.
(Therefore, <code>tc</code> is rarely seen in dig output.)
</li>
<li>The <code>+ignore</code> flag tells dig to not re-query with TCP (Example below.)
</li>
<li>When <code>dig</code> re-queries with TCP, a message is displayed that can't be suppressed.
<pre class="example">
$ dig +noall dnslab.org DNSKEY +dnssec
;; Truncated, retrying in TCP mode.
$
</pre>
</li>
</ul>
</li>
<li>The response is too big, but dig doesn't re-query with TCP.
<pre class="example">
$ dig dnslab.org dnskey +dnssec +ignore
; &lt;&lt;&gt;&gt; DiG 9.9.4 &lt;&lt;&gt;&gt; dnslab.org dnskey +dns +ignore
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 20521
;; flags: qr tc rd ra ad; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 800

;; QUESTION SECTION:
;dnslab.org.			IN	DNSKEY

;; Query time: 9 msec
;; SERVER: 192.168.53.251#53(192.168.53.251)
;; WHEN: Wed Nov 25 14:05:05 UTC 2015
;; MSG SIZE  rcvd: 39
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-15" class="outline-3">
<h3 id="sec-11-15"><span class="section-number-3">11.15</span> DNSSEC troubleshooting</h3>
<div class="outline-text-3" id="text-11-15">
</div><div id="outline-container-sec-11-15-1" class="outline-4">
<h4 id="sec-11-15-1"><span class="section-number-4">11.15.1</span> Checking DNS resolution issues</h4>
<div class="outline-text-4" id="text-11-15-1">
</div><ol class="org-ol"><li><a id="sec-11-15-1-1" name="sec-11-15-1-1"></a>dig<br ><div class="outline-text-5" id="text-11-15-1-1">
<p>
The DNS name resolution tool <code>dig</code> can be used to test the general
function of a DNS resolver, or to test if an error condition exist at
the remote DNS authoritative servers of a domain.
</p>
</div>
<ol class="org-ol"><li><a id="sec-11-15-1-1-1" name="sec-11-15-1-1-1"></a>Testing one DNS resolver over UDP<br ><div class="outline-text-6" id="text-11-15-1-1-1">
<p>
To test the general connectivity and operation of a DNS resolver, a
query for well known DNS data can be sent, such as for the list of
name-server (NS records) of the root zone <code>"."</code>. The answer should contain
the list of all 13 root name server in the Internet (with the names
<code>a-m.root-servers.net</code>)
</p>

<pre class="example">
$ dig @IP-of-DNS-resolver NS .
</pre>

<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>what are reasons we recommend using the IP address of a resolver instead of its
name?
</li>
</ul>
<p>
</div>
</p>
</div>
</li>

<li><a id="sec-11-15-1-1-2" name="sec-11-15-1-1-2"></a>Testing one DNS resolver over TCP<br ><div class="outline-text-6" id="text-11-15-1-1-2">
<p>
The DNS resolver should also be reachable over TCP, to send a query
via TCP the flag <code>+tcp</code> has to be appended to the query
</p>

<pre class="example">
$ dig @IP-of-DNS-resolver NS . +tcp
</pre>

<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>you can save 33% typing by using <code>+vc</code> instead of <code>+tcp</code>. What
does <code>vc</code> do? Check the manual page for <code>dig(1)</code>.
</li>
</ul>
<p>
</div>
</p>
</div>
</li>

<li><a id="sec-11-15-1-1-3" name="sec-11-15-1-1-3"></a>Testing reachability of all authoritative DNS servers<br ><div class="outline-text-6" id="text-11-15-1-1-3">
<p>
The <code>dig</code> function <code>+nssearch</code> will first query all NS records for a
given domain and then will try to query directly (without going to a
DNS-resolver) the authoritative DNS servers of that domain:
</p>
<pre class="example">
$ dig @IP-of-DNS-resolver example.com +nssearch
</pre>
<p>
The function will print out the SOA record of the zone (here
<code>example.com</code>) for each DNS server that has send an answer to the
query, including the SOA serial, the IPv4 and/or IPv6 address and the
round-trip-time (RTT) of the query.
</p>

<p>
All SOA serial numbers should show the same number, else there might
be an issue with zone synchronization via zone transfer which might be
a possible cause for DNS lookup problems.
</p>

<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>which type of DNS servers (authoritative, recursive, primary, secondary)
are at fault if the SOA serial numbers of a zone are not in sync?
Who can correct the fault?
</li>
</ul>
<p>
</div>
</p>
</div>
</li>
<li><a id="sec-11-15-1-1-4" name="sec-11-15-1-1-4"></a>Testing the resolution chain<br ><div class="outline-text-6" id="text-11-15-1-1-4">
<p>
The function <code>+trace</code> in <code>dig</code> will trace the DNS name resolution
starting from the root DNS server system down to the requested name.
</p>
<pre class="example">
$ dig @IP-of-DNS-resolver example.com +trace
</pre>
<p>
Only the very first query to find the root-server addresses will be
done towards the DNS resolver given in the command, all other queries
will be sent directly to the DNS resolver. This function tests and
prints one of usually many possible DNS resolution paths. A successful
return of the command does not indicate that the resolution path is
without errors, it is only an indication that at least one successful
path exists.
</p>
</div>
</li>
<li><a id="sec-11-15-1-1-5" name="sec-11-15-1-1-5"></a>Testing for DNSSEC validation issues<br ><div class="outline-text-6" id="text-11-15-1-1-5">
<p>
If a DNS query returns a <code>SERVFAIL</code> answer, it can be a DNSSEC
validation issue at the DNS resolver, or it can be some kind of server
malfunction on the DNS resolver or the remote authoritative server.
</p>

<p>
In order the check for DNSSEC validation issues, the administrator can
send a DNS query with the <code>+cd</code> flag (Checking Disabled). With this
flag set, the DNS resolver will skip DNSSEC validation and will return
the DNS data to <code>dig</code> even in case the DNSSEC validation would fail.
</p>

<p>
So if a DNS query returns data when <code>+cd</code> is set, but returns
<code>SERVFAIL</code> when <code>+cd</code> is not set, this indicates a DNSSEC validation
issue. If the answer is always <code>SERVFAIL</code>, it is some other kind
of problem (usually not DNSSEC).
</p>
</div>
</li></ol>
</li>

<li><a id="sec-11-15-1-2" name="sec-11-15-1-2"></a>External web services to check DNS<br ><div class="outline-text-5" id="text-11-15-1-2">
<p>
Several website services exist that help DNS administrators to check
the health of a DNS system
</p>
</div>
<ol class="org-ol"><li><a id="sec-11-15-1-2-1" name="sec-11-15-1-2-1"></a>Zonemaster<br ><div class="outline-text-6" id="text-11-15-1-2-1">
<p>
The website <a href="https://zonemaster.net">Zonemaster https://zonemaster.net</a> is a collaboration
between the French TLD registry Afnic and the Swedish registry IIS.
The website takes a domain name and will generate a report of errors
and best practice recommendations of the setup of this domain name.
</p>
</div>
</li>
<li><a id="sec-11-15-1-2-2" name="sec-11-15-1-2-2"></a>DNSViz<br ><div class="outline-text-6" id="text-11-15-1-2-2">
<p>
<a href="https://dnsviz.net">DNSViz https://dnsviz.net</a> is a tool for visualizing the
status of a DNS zone. It provides a visual analysis of the DNSSEC
authentication chain for a domain name and its resolution path in the DNS
namespace, and it lists configuration errors detected by the tool.
</p>
</div>
</li></ol>
</li></ol>
</div>
<div id="outline-container-sec-11-15-2" class="outline-4">
<h4 id="sec-11-15-2"><span class="section-number-4">11.15.2</span> Looking into DNSSEC validation issues</h4>
<div class="outline-text-4" id="text-11-15-2">
<p>
DNSEC validation issues are often a problem with misconfiguration at
the authoritative DNS server side of the domain, not an issue of the
DNS resolver system. However to be able to debug DNSSEC issues, for
example to decide if an NTA (negative trust anchor) should be inserted
into the DNS resolver system to temporarily disable DNSSEC validation
for a specific domain, the DNSSEC validation issue should be
investigated first.
</p>
</div>
<ol class="org-ol"><li><a id="sec-11-15-2-1" name="sec-11-15-2-1"></a>DNSSEC validation troubleshooting with "delv"<br ><div class="outline-text-5" id="text-11-15-2-1">
<p>
The tool <code>delv</code> is part of the BIND 9 DNS server and implements a full
DNS resolver and DNSSEC validator inside the command line tool. This
tool works very similarly to <code>dig</code> (and shares the same command line
syntax), but where <code>dig</code> always needs a DNS resolver to get the DNS
information, <code>delv</code> can query the data and can validate the DNSSEC
information itself.
</p>
</div>
</li>
<li><a id="sec-11-15-2-2" name="sec-11-15-2-2"></a>Message trace<br ><div class="outline-text-5" id="text-11-15-2-2">
<p>
The flag <code>+mtrace</code> enables the message tracing in <code>delv</code>, the tool
will print all DNS queries and answers during the processing of the
query.
</p>
<pre class="example">
$ delv example.com +mtrace
</pre>
</div>
</li>

<li><a id="sec-11-15-2-3" name="sec-11-15-2-3"></a>Validation trace<br ><div class="outline-text-5" id="text-11-15-2-3">
<p>
The flag <code>+vtrace</code> will print a debug trace of all DNSSEC validation
steps the tool will do in order to validate the received DNS answers
</p>
<pre class="example">
$ delv example.com +vtrace
</pre>
</div>
</li>
<li><a id="sec-11-15-2-4" name="sec-11-15-2-4"></a>Name server mode (BIND 9.20+)<br ><div class="outline-text-5" id="text-11-15-2-4">
<ul class="org-ul">
<li>The new command-line delv +ns option activates name server mode, to
more accurately reproduce the behavior of named when resolving a
query. In this mode, delv uses an internal recursive resolver
rather than an external server. All messages sent and received
during the resolution and validation process are logged. This can
be used in place of dig +trace. 
<pre class="example">
% delv +ns dnssec.works | less
</pre>
</li>
</ul>
</div>
</li>
<li><a id="sec-11-15-2-5" name="sec-11-15-2-5"></a>DNSSEC path validation with drill<br ><div class="outline-text-5" id="text-11-15-2-5">
<p>
The tool <code>drill</code> is part of the LDNS tools (Debian/Ubuntu package
<code>ldnsutils</code>) and is a <code>dig</code> lookalike tool with additional
features. One notable feature is the function to trace the DNSSEC
validation and to print the DNSSEC chain-of-trust together with the
DNSSEC key information.
</p>

<p>
<code>drill</code> requires the current DNSSEC root trust anchor in a file to be
able to work. This trust anchor can be received with <code>drill</code>, but also
with <code>dig</code> or <code>delve</code>:
</p>
<pre class="example">
$ dig @a.root-servers.net . DNSKEY | grep 257 &gt; root.key
</pre>
<p>
This DNSSEC root trust-anchor key can be used to do a DNSSEC chain
chase with <code>drill</code>:
</p>
<pre class="example">
$ drill -SD -k root.key example.com
</pre>

<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>In the example above we fetched the root DNSKEY with <code>dig</code>.
Is this method for obtaining the root DNSKEY record foolproof,
and do you consider it secure?
Write answers in the chat.
</li>
</ul>
<p>
</div>
</p>
</div>
</li></ol>
</div>
</div>
</div>
<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> Getting information</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1"><span class="section-number-3">12.1</span> Statistics</h3>
<div class="outline-text-3" id="text-12-1">
</div><div id="outline-container-sec-12-1-1" class="outline-4">
<h4 id="sec-12-1-1"><span class="section-number-4">12.1.1</span> RNDC statistics</h4>
<div class="outline-text-4" id="text-12-1-1">
<ul class="org-ul">
<li><code>rndc stats</code>: Write BIND statistics to a file.
<ul class="org-ul">
<li>The default file is: <code>named.stats</code>
</li>
<li>It can be changed with the <code>statistics-file</code> statement in <code>named.conf</code>
</li>
</ul>
<pre class="example">
% rndc stats
</pre>
</li>
<li>Rerunning rndc stats appends the file
<pre class="example">
% rndc stats
% more /var/named/named.stats
+++ Statistics Dump +++ (1385101842)
++ Incoming Requests ++
              154700 QUERY
                   4 IQUERY
                  49 NOTIFY
++ Incoming Queries ++
              103379 A
                8330 NS
                1507 CNAME
                1857 SOA
                7716 PTR
                3755 MX
               16795 TXT
                6913 AAAA
                 159 SRV
                 292 NSEC
                1885 DNSKEY
                   64 IXFR
                   3 AXFR
                  143 ANY
++ Outgoing Queries ++
[View: default]
               95395 A
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-1-2" class="outline-4">
<h4 id="sec-12-1-2"><span class="section-number-4">12.1.2</span> XML/JSON/Web Statistics-Channel</h4>
<div class="outline-text-4" id="text-12-1-2">
<ul class="org-ul">
<li>BIND can be monitored over a web interface.
<ul class="org-ul">
<li>The statistics-channel is enabled in <code>named.conf</code>,
</li>
<li>note, this is not under <code>options {}</code>, but its own stanza.
</li>
<li>This config listens on all IP addresses, TCP port 5353, but only the host 192.168.53.101 can connect.
</li>
</ul>
</li>
</ul>
<pre class="example">
statistics-channels {
        inet * port 5353 allow { 192.168.53.101; };
};
</pre>

<p>
<img src="./img/XML-statistics.png" class="img-responsive" alt="XML-statistics.png">
<div class="exercise">
</p>
<ul class="org-ul">
<li>The statistics file produced by <code>rndc stats</code> is frequently used by
monitoring tools to produce pretty graphs. Logged into your server,
space out two invocations of <code>rndc stats</code> and check the output
in your server's statistics file.
What could be problems when processing this file? Write answers in the chat.
</li>
<li>Enable the XML statistics channel in <code>named.conf</code>
<pre class="example">
 statistics-channels {
      inet * port 80 allow { any; };
};
</pre>
</li>
<li>SELinux restricts the ports that the BIND 9 process <code>named</code> can
use. Allow the <code>named</code> process to bind to port 80 (HTTP)
<pre class="example">
% setsebool named_tcp_bind_http_port 1
</pre>
</li>
<li>Open port 80 in the firewall
<pre class="example">
% firewall-cmd --permanent --zone=public --add-port=80/tcp
% firewall-cmd --reload
</pre>
</li>
<li>Restart (not reload) the BIND 9 server process
<pre class="example">
% systemctl restart isc-bind-named
</pre>
</li>
<li>Use the <code>netstat</code>, <code>ss</code> or <code>lsof</code> (needs to be installed) commands
to verify that the <code>named</code> process does listen on port 80
</li>
<li>Access the web-page on the server with your browser
</li>
<li>Use the <code>curl</code> utility to query your server at the URL
<code>http://127.0.0.1/json</code> and note the server's <code>version</code> number.
Write the answer in the chat.
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-12-2" class="outline-3">
<h3 id="sec-12-2"><span class="section-number-3">12.2</span> Query Logging</h3>
<div class="outline-text-3" id="text-12-2">
</div><div id="outline-container-sec-12-2-1" class="outline-4">
<h4 id="sec-12-2-1"><span class="section-number-4">12.2.1</span> Logging of Queries</h4>
<div class="outline-text-4" id="text-12-2-1">
<ul class="org-ul">
<li>Query logging stores queries arriving at a server.
<ul class="org-ul">
<li>A minimum log typically includes:the client socket, qname,
qclass, qtype
</li>
<li>Extensive logging may add:message flags, EDNS content (version,
cookie presence &amp; type, etc.), the server socket, UDP/TCP,
arrival time
</li>
<li>Extensive logging can elect to not log select queries (e.g.
queries dropped because of RRL)
</li>
</ul>
</li>
<li>Query logging generally does not:
<ul class="org-ul">
<li>Log responses
</li>
<li>Log if multiple outgoing queries were required (e.g. CNAME
responses, referrals, etc)
</li>
<li>Record the time from query arrival until response
</li>
<li>Indicate if a query was answered from the cache
</li>
<li>Indicate if an RPZ rule was triggered
</li>
<li>Indicate if RRL was applied, etc.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-2-2" class="outline-4">
<h4 id="sec-12-2-2"><span class="section-number-4">12.2.2</span> Why Queries Are Logged</h4>
<div class="outline-text-4" id="text-12-2-2">
<ul class="org-ul">
<li>Query logging is implemented for various reasons.
<ul class="org-ul">
<li>To meet legal requirements.
</li>
<li>Aid in tracing the source of problematic traffic (e.g. access of malware, corporate rule violation, illegal activity, etc).
</li>
<li>Debugging (both DNS itself and aiding in other debugging).
</li>
<li>Traffic analysis to decide where to add/relocate DNS servers.
</li>
<li>Traffic trend analysis can help decide BGP peerings.
</li>
<li>Traffic analysis can be used to select to spend advertising dollars.
</li>
<li>Traffic analysis can be used for targeting marketing.
</li>
<li>Measuring has importance unto itself.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-2-3" class="outline-4">
<h4 id="sec-12-2-3"><span class="section-number-4">12.2.3</span> Server Query Logging</h4>
<div class="outline-text-4" id="text-12-2-3">
<ul class="org-ul">
<li>Query logging slows DNS servers very significantly.
<ul class="org-ul">
<li>Tests show a server with 400 kqps drops below 50% performance
with query logging enabled.
</li>
<li>Other tests show a 200% performance drop (a quarter of the rate)
compared to query logging disabled.
</li>
</ul>
</li>
<li>In BIND, query logging is disabled by default.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-2-4" class="outline-4">
<h4 id="sec-12-2-4"><span class="section-number-4">12.2.4</span> BIND Query Logging</h4>
<div class="outline-text-4" id="text-12-2-4">
<ul class="org-ul">
<li>Query logging generates one line for each query received, and can be toggled on/off with:
<pre class="example">
% rndc querylog
</pre>
</li>
<li>Useful for troubleshooting, but not if the server is overloaded.
</li>
<li>A server receiving 100 qps handles logging without a performance impact.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-2-5" class="outline-4">
<h4 id="sec-12-2-5"><span class="section-number-4">12.2.5</span> Query Logging: What is Logged</h4>
<div class="outline-text-4" id="text-12-2-5">
<ul class="org-ul">
<li>9.1.X-9.2.X: client, qname, qclass, qtype
</li>
<li>9.3.X-9.4.X: Above plus: RD, signed, EDNS
</li>
<li>9.5.X-9.6.X: Above plus: DO, CD
</li>
<li>9.7.X-9.10.X: Above plus: local address
</li>
<li>9.11.X-9.12.X: client, qname, qclass, qtype, RD, signed, <b>EDNS</b> +
<b>version</b>, <b>TCP</b>, DO, CD, <b>cookies</b>, local address
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-2-6" class="outline-4">
<h4 id="sec-12-2-6"><span class="section-number-4">12.2.6</span> BIND Query Log Configuration</h4>
<div class="outline-text-4" id="text-12-2-6">
<ul class="org-ul">
<li>A query log is shown below from a server with this
configuration:
</li>
</ul>
<pre class="example">
logging {
  channel query_log {
    file "query_log";
    print-category yes;   # The print options make each entry
    print-severity yes;   # of a logged query longer.
    print-time yes;
  };
  &lt;OUTPUT SUPPRESSED&gt;
  category queries { query_log; };
  &lt;OUTPUT SUPPRESSED&gt;
};
</pre>

<p>
<img id="query-log" class="img-responsive" src="img/query-log-00.png"></ p><input type="button" onclick="NextPage('query-log','11')" value=">" /><input type="button" onclick="ResetSlides('query-log')" value="O" /><input type="button" onclick="PrevPage('query-log')" value="<" />
</p>
</div>
</div>

<div id="outline-container-sec-12-2-7" class="outline-4">
<h4 id="sec-12-2-7"><span class="section-number-4">12.2.7</span> Query Logging Flags</h4>
<div class="outline-text-4" id="text-12-2-7">
<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="text-left">Flag</th>
<th scope="col" class="text-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="text-left">+</td>
<td class="text-left">RD flag set (recursive query)</td>
</tr>

<tr>
<td class="text-left">-</td>
<td class="text-left">RD flag cleared (iterative)</td>
</tr>

<tr>
<td class="text-left">T</td>
<td class="text-left">Query over TCP</td>
</tr>

<tr>
<td class="text-left">D</td>
<td class="text-left">DO flag set (DNSSEC OK)</td>
</tr>

<tr>
<td class="text-left">S</td>
<td class="text-left">Signed query (TSIG)</td>
</tr>

<tr>
<td class="text-left">K</td>
<td class="text-left">Cookie option, but no valid server cookie</td>
</tr>

<tr>
<td class="text-left">E(#)</td>
<td class="text-left">EDNS query &amp; version</td>
</tr>

<tr>
<td class="text-left">V</td>
<td class="text-left">Query with valid server cookie</td>
</tr>
</tbody>
</table>
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Work on the DNS resolver server <code>dnsrNN</code>
</li>
<li>Configure query-logging in the BIND 9 configuration file
<code>named.conf</code>
</li>
<li>Check and reload the configuration
</li>
<li>Enable query-logging with <code>rndc querylog</code>
</li>
<li>Send the query below to your DNS resolver
<pre class="example">
dig @dnsrNN.dnslab.org dnssec.works +dnssec +multi
</pre>
</li>
<li>Which query flags do you see in the query logs. Write the answer in the chat.
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-12-3" class="outline-3">
<h3 id="sec-12-3"><span class="section-number-3">12.3</span> Packet Capture (Passive Replication)</h3>
<div class="outline-text-3" id="text-12-3">
</div><div id="outline-container-sec-12-3-1" class="outline-4">
<h4 id="sec-12-3-1"><span class="section-number-4">12.3.1</span> Packet Capture for Query Logging</h4>
<div class="outline-text-4" id="text-12-3-1">
<ul class="org-ul">
<li>An alternative to server query logging is packet capture.
</li>
<li>Packet capture is external of the DNS server.
<ul class="org-ul">
<li>It does not slow a server.
</li>
<li>It is commonly done with port mirroring.
</li>
<li>It is also known as passive replication.
</li>
</ul>
</li>
<li>Because packets are not the same as DNS messages, packet capture
has limitations
</li>
<li>Packet capture systems work extra for actions that happen
automatically in a DNS server:
<ul class="org-ul">
<li>e.g. DNS message building for IP fragmentation
</li>
<li>e.g. DNS message building for TCP streams
</li>
</ul>
</li>
<li>Information is lost with packet capture.
<ul class="org-ul">
<li>e.g. Did the server drop the query?
</li>
<li>e.g. Was the query answered from the cache?
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-3-2" class="outline-4">
<h4 id="sec-12-3-2"><span class="section-number-4">12.3.2</span> Server Logging Alternatives</h4>
<div class="outline-text-4" id="text-12-3-2">
<ul class="org-ul">
<li>Packet capture for query logging is commonly in PCAP or PCAPng (next generation) formats.
<ul class="org-ul">
<li><code>tcpdump</code> &amp; <code>wireshark</code> can be used for capture, display &amp;
analysis.
</li>
<li>Capture tools specifically designed for DNS offer better
monitoring and analysis.
<ul class="org-ul">
<li>Such tools are outside the scope of this course, but several
are presented on the next slides.
</li>
</ul>
</li>
</ul>
</li>
<li>A new RFC 8618 "Compacted-DNS (C-DNS): A Format for DNS Packet
Capture" offers improvements over PCAP/PCAPng (published September
2019): <a href="https://tools.ietf.org/html/rfc8618">https://tools.ietf.org/html/rfc8618</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-3-3" class="outline-4">
<h4 id="sec-12-3-3"><span class="section-number-4">12.3.3</span> Open Source DNS Packet tools</h4>
<div class="outline-text-4" id="text-12-3-3">
<ul class="org-ul">
<li>DSC (DNS Statistics Collector) is a packet capture and presentation
tool. (It is used by the root servers.)
<ul class="org-ul">
<li><a href="https://www.dns-oarc.net/tools/dsc">https://www.dns-oarc.net/tools/dsc</a>
</li>
<li><a href="https://www.caida.org/tools/utilities/dsc/">https://www.caida.org/tools/utilities/dsc/</a>
</li>
</ul>
</li>
<li>Hedgehog is an alternative to the DSC presenter which can be used
to display real time statistics for DNS traffic.
<ul class="org-ul">
<li><a href="https://github.com/dns-stats/hedgehog">https://github.com/dns-stats/hedgehog</a>
</li>
</ul>
</li>
<li>DNSCAP is a packet capture tool and presentation used for the DITL
(Day in The Life of root server) collection.
<a href="https://www.dns-oarc.net/tools/dnscap">https://www.dns-oarc.net/tools/dnscap</a>
</li>
<li>PacketQ (formerly DNS2db) is a PCAP analysis tool: <a href="https://www.dns-oarc.net/tools/packetq">https://www.dns-oarc.net/tools/packetq</a>
</li>
<li><code>nmsg</code> pretty prints DNS messages from PCAP files: <a href="https://github.com/farsightsec/nmsg">https://github.com/farsightsec/nmsg</a>
</li>
<li><code>drool</code> (DNS Replay Tool) replays DNS packets from a PCAP to a server.
<ul class="org-ul">
<li>It can produce high traffic volume and be used to test
performance under extreme load (e.g DDoS attacks):
<a href="https://www.dns-oarc.net/tools/drool">https://www.dns-oarc.net/tools/drool</a>
</li>
</ul>
</li>
<li><code>dnsjit</code> captures, parses and replays DNS.
<blockquote>
<p>
"&#x2026;parts taken from dsc, dnscap, drool&#x2026; script-based engine for
easy capturing, parsing &amp; statistics gathering&#x2026; also replaying
DNS traffic."
</p>
</blockquote>
<p>
<a href="https://www.dns-oarc.net/tools/dnsjit">https://www.dns-oarc.net/tools/dnsjit</a>
</p>
</li>
<li>Various PCAP tools from PowerDNS:
<ul class="org-ul">
<li><code>dnsscope</code> generates statistics from a PCAP
</li>
<li><code>dnsreplay</code> replays a PCAP's DNS queries
</li>
<li><code>dnsscan</code> prints query-type amounts from a PCAP
</li>
<li><code>dnswasher</code> - Obviscates client IPs in a PCAP
</li>
<li><a href="https://doc.powerdns.com/md/tools/analysis/">https://doc.powerdns.com/md/tools/analysis/</a>
</li>
</ul>
</li>
<li>Go Language DNS interface: includes message parsing/output:
<a href="https://github.com/miekg/dns">https://github.com/miekg/dns</a>
</li>
<li><code>dnspython</code>: a DNS toolkit for Python: <a href="https://www.dnspython.org">https://www.dnspython.org</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-3-4" class="outline-4">
<h4 id="sec-12-3-4"><span class="section-number-4">12.3.4</span> Related DNS Tools</h4>
<div class="outline-text-4" id="text-12-3-4">
<ul class="org-ul">
<li>DNS-OARC develops other tools beyond those listed: <a href="https://www.dns-oarc.net/oarc/software">https://www.dns-oarc.net/oarc/software</a>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-12-4" class="outline-3">
<h3 id="sec-12-4"><span class="section-number-3">12.4</span> DNSTAP</h3>
<div class="outline-text-3" id="text-12-4">
<ul class="org-ul">
<li><i>dnstap</i> is a query logging system integral to a server (e.g. named).
</li>
<li>Unlike traditional query logging, it has only a minor effect on
server performance.
</li>
<li>Unlike passive replication (packet capture) it doesn't duplicate
server work nor is information lost.
</li>
<li>In addition to BIND, dnstap is available in many DNS servers.
</li>
<li>A DNS server's thread writes to a circular buffer in memory.
</li>
</ul>


<figure>
<p><img src="./img/dnstap-01.png" class="img-responsive" alt="dnstap-01.png">
</p>
</figure>

<ul class="org-ul">
<li>Another server thread reads the buffer and outputs to a UNIX domain
socket, or to a dnstap formatted file.
</li>
</ul>


<figure>
<p><img src="./img/dnstap-02.png" class="img-responsive" alt="dnstap-02.png">
</p>
</figure>

<ul class="org-ul">
<li>An external process reads from the socket and writes to a file.
</li>
</ul>


<figure>
<p><img src="./img/dnstap-03.png" class="img-responsive" alt="dnstap-03.png">
</p>
</figure>

<ul class="org-ul">
<li>The server will overwrite un-logged queries in the buffer rather than block.
<ul class="org-ul">
<li>Some queries may not be logged.
</li>
<li>While this may happen on servers under extreme load, it will be rare.
</li>
</ul>
</li>
</ul>


<figure>
<p><img src="./img/dnstap-04.png" class="img-responsive" alt="dnstap-04.png">
</p>
</figure>
</div>

<div id="outline-container-sec-12-4-1" class="outline-4">
<h4 id="sec-12-4-1"><span class="section-number-4">12.4.1</span> DNSTAP in BIND 9</h4>
<div class="outline-text-4" id="text-12-4-1">
<ul class="org-ul">
<li><i>dnstap</i> was first fully available in BIND 9.11.
<ul class="org-ul">
<li>(Initial but limited support began with BIND 9.9.8.)
</li>
</ul>
</li>
<li><i>dnstap</i> must be enabled when BIND is built (<i>dnstap</i> is enabled in
the BIND 9 binaries from the ISC repositories).
</li>
</ul>
<pre class="example">
$ ./configure --enable-dnstap [other configure options]
</pre>
<ul class="org-ul">
<li><i>dnstap</i> is dependent on non-ISC software:
<ol class="org-ol">
<li>Protocol buffers (<code>protobuf</code>) library (Google)
</li>
<li><code>protobuf-c</code> library
</li>
<li><code>fstrm</code> (Frame Streams) library (Farsight Security)
</li>
</ol>
</li>
<li>Without the dependencies, you can't build BIND 9 with dnstap:
</li>
</ul>
<pre class="example">
$ ./configure --enable-dnstap
checking build system type... x86_64-unknown-linux-gnu
checking host system type... x86_64-unknown-linux-gnu
[...]
checking for dlsym... yes
checking for protoc-c... no
configure: error: The protoc-c program was not found.
</pre>
</div>
</div>
<div id="outline-container-sec-12-4-2" class="outline-4">
<h4 id="sec-12-4-2"><span class="section-number-4">12.4.2</span> DNSTAP configuration</h4>
<div class="outline-text-4" id="text-12-4-2">
<ul class="org-ul">
<li>These are the complete dnstap settings.
</li>
<li>Just two are required and common: <code>dnstap</code> &amp; <code>dnstap-output</code>
</li>
</ul>
<pre class="example">
options {
  dnstap {
    (all|auth|client|forwarder|resolver) [(query|response)]; ... };
  dnstap-output (file|unix) quoted_string
    [size (unlimited|size)]
    [versions(unlimited|integer)]
    [suffix ( increment | timestamp ) ];
  dnstap-identity (quoted_string|none|hostname );
  dnstap-version ( quoted_string | none );

  fstrm-set-buffer-hint integer;
  fstrm-set-flush-timeout integer;
  fstrm-set-input-queue-size integer;
  fstrm-set-output-notify-threshold integer;
  fstrm-set-output-queue-model ( mpsc | spsc );
  fstrm-set-output-queue-size integer;
  fstrm-set-reopen-interval integer;
};
</pre>
</div>
<ol class="org-ol"><li><a id="sec-12-4-2-1" name="sec-12-4-2-1"></a>options {dnstap{}}<br ><div class="outline-text-5" id="text-12-4-2-1">
<pre class="example">
# dnstap { (all|auth|client|forwarder|resolver) [(query|response)]; ...};
# dnstap {all};
dnstap { client; resolver query; };
</pre>
<ul class="org-ul">
<li>Enable dnstap &amp; select message types to log.
<ul class="org-ul">
<li>Default: both queries and responses are logged.
</li>
<li><code>client</code>: arriving queries except for AXFR/IXFR generally matches
the common understanding of query logging.
</li>
<li><code>resolver</code>: outgoing queries from a DNS Resolver server
</li>
<li><code>auth</code>: arriving AXFR/IXFR queries (even for DNS Resolver
servers)
</li>
<li><code>forwarder</code>: outgoing queries to a forwarder from a DNS Resolver
server
</li>
</ul>
</li>
</ul>
</div>
</li>
<li><a id="sec-12-4-2-2" name="sec-12-4-2-2"></a>options {dnstap-output}<br ><div class="outline-text-5" id="text-12-4-2-2">
<pre class="example">
/* dnstap-output (file|unix) quoted_string
   [size (unlimited|size)]
   [versions(unlimited|integer)]
   [suffix ( increment | timestamp ) ]; */
 dnstap-output file "tap.data" size 1M versions 5 suffix timestamp;
</pre>
<ul class="org-ul">
<li><code>dnstap-output</code>: select a UNIX domain socket or file for output.
</li>
<li>BIND does not provide a listener.
<ul class="org-ul">
<li><code>fstrm_capture</code> is a socket listener program from the fstrm
library.
</li>
</ul>
</li>
<li>Size, versions &amp; suffix are only applicable for file output.
</li>
<li>The default is to allow the file to grow indefinitely.
<ul class="org-ul">
<li>If set, when size is reached, the file is rolled.
</li>
<li><code>suffix</code> defaults to <code>increment</code>: 0, 1, 2, 3, &#x2026;
</li>
<li><code>versions</code> is the number of older versions to keep.
</li>
</ul>
</li>
<li><code>dnstap-output</code> cannot be used in a view.
</li>
<li><code>dnstap-output</code> is not reread by: <code>rndc reconfig</code> (A noteworthy
anomaly).
</li>
</ul>
</div>
</li>
<li><a id="sec-12-4-2-3" name="sec-12-4-2-3"></a>options{dnstap-identity &amp; dnstap-version}<br ><div class="outline-text-5" id="text-12-4-2-3">
<pre class="example">
# dnstap-identity (quoted_string|none|hostname );
# dnstap-identity "FunFunFun";
dnstap-identity hostname;  # The default
</pre>
<ul class="org-ul">
<li><code>dnstap-identity</code>: a string sent in dnstap messages: <code>hostname</code> is
the default.
</li>
</ul>
<pre class="example">
# dnstap-version ( quoted_string | none );
# dnstap-version "BIND 4.3 (just kidding!)";
</pre>
<ul class="org-ul">
<li><code>dnstap-version</code>: a string sent in dnstap messages: the BIND
version is the default.
</li>
</ul>
</div>
</li>
<li><a id="sec-12-4-2-4" name="sec-12-4-2-4"></a>options {fstrm-set-*}<br ><div class="outline-text-5" id="text-12-4-2-4">
<pre class="example">
options {
  fstrm-set-buffer-hint integer;
  fstrm-set-flush-timeout integer;
  fstrm-set-input-queue-size integer;
  fstrm-set-output-notify-threshold integer;
  fstrm-set-output-queue-model ( mpsc | spsc );
  fstrm-set-output-queue-size integer;
  fstrm-set-reopen-interval integer;
};
</pre>
<ul class="org-ul">
<li><code>fstrm</code> library options (<a href="https://github.com/farsightsec/fstrm">https://github.com/farsightsec/fstrm</a>) tune
performance or prevent data loss.
<ul class="org-ul">
<li>The BIND ARM has more information.
</li>
</ul>
</li>
</ul>
</div>
</li></ol>
</div>
<div id="outline-container-sec-12-4-3" class="outline-4">
<h4 id="sec-12-4-3"><span class="section-number-4">12.4.3</span> dnstap-read</h4>
<div class="outline-text-4" id="text-12-4-3">
<ul class="org-ul">
<li><code>dnstap-read</code> is a BIND tool for printing the content of a dnstap output file as text.
<ul class="org-ul">
<li>Default: one line is printed for each log entry.
</li>
<li><code>-p</code>: Prints the entire DNS message.
</li>
<li><code>-y</code>: Print the entire message in YAML format.
</li>
<li>See the ARM or man page for other options.
</li>
</ul>
</li>
<li>Various other tools are available for reading dnstap output,
including several that are packaged with the fstrm library.
</li>
<li>The following examples show <b>dnstap</b> logging direct to a file from
an DNS Resolver server with this configuration and with an empty
cache:
</li>
</ul>
<pre class="example">
options {
 [...]
 dnstap {all;};
 dnstap-output file "tap.data";
 [...]
 };
</pre>


<figure>
<p><img src="./img/dnstap-05.png" class="img-responsive" alt="dnstap-05.png">
</p>
</figure>

<ul class="org-ul">
<li>Query: <code>dig AAAA www.ripe.net</code>
</li>
<li>message types:
<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">CQ</td>
<td class="text-left">Client Query</td>
</tr>

<tr>
<td class="text-left">CR</td>
<td class="text-left">Client Response</td>
</tr>

<tr>
<td class="text-left">RQ</td>
<td class="text-left">Resolver Query</td>
</tr>

<tr>
<td class="text-left">RR</td>
<td class="text-left">Resolver Response</td>
</tr>

<tr>
<td class="text-left">AQ</td>
<td class="text-left">Auth Query</td>
</tr>

<tr>
<td class="text-left">AR</td>
<td class="text-left">Auth Response</td>
</tr>
</tbody>
</table>
</li>
</ul>

<pre class="example">
% dnstap-read tap.data | grep AAAA
01-Dec-2018 19:24:24.381 CQ 10.156.0.2:33879 -&gt; 10.156.0.2:0 UDP 53b www.ripe.net/IN/AAAA
01-Dec-2018 19:24:24.471 RQ 10.156.0.2:52320 -&gt; 202.12.31.53:53 UDP 53b www.ripe.net/IN/AAAA
01-Dec-2018 19:24:24.702 RR 10.156.0.2:52320 &lt;- 202.12.31.53:53 UDP 265b www.ripe.net/IN/AAAA
01-Dec-2018 19:24:25.249 CR 10.156.0.2:33879 &lt;- 10.156.0.2:0 UDP 97b www.ripe.net/IN/AAAA
</pre>
</div>
</div>
<div id="outline-container-sec-12-4-4" class="outline-4">
<h4 id="sec-12-4-4"><span class="section-number-4">12.4.4</span> Example:dnstap-read -p</h4>
<div class="outline-text-4" id="text-12-4-4">
<ul class="org-ul">
<li>This is the final dnstap log entry from the previous example, but
showing the entire DNS message (<code>dnstap -p</code> option).Notice that the
formatting is similar to dig's.
</li>
</ul>
<pre class="example">
% dnstap-read -p tap.data | grep -A11 19:24:25.249.CR

01-Dec-2018 19:24:25.249 CR 10.156.0.2:33879 &lt;- 10.156.0.2:0 UDP 97b www.ripe.net/IN/AAAA

;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id:  25072
;; flags: qr rd ra ad; QUESTION: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: fc8ba016d9bcee6268e76d975c02dfe96b3eb57323196b28
;; QUESTION SECTION:
;www.ripe.net.			IN	AAAA
;; ANSWER SECTION:
www.ripe.net.		21600	IN	AAAA	2001:67c:2e8:22::c100:68b
</pre>
</div>
</div>
<div id="outline-container-sec-12-4-5" class="outline-4">
<h4 id="sec-12-4-5"><span class="section-number-4">12.4.5</span> rndc &amp; dnstap</h4>
<div class="outline-text-4" id="text-12-4-5">
<ul class="org-ul">
<li>The circular buffer is written asynchronously.
</li>
<li>rndc can force the buffer to be written (file only).
<ul class="org-ul">
<li>This rotates the file, even if named is not configured to keep
multiple versions.
</li>
</ul>
</li>
</ul>
<pre class="example">
% ls -ltr tap.data*
-rw-r--r--. 1 root root 163840 Dec  1 21:17 tap.data

% rndc dnstap -reopen

% ls -ltr tap.data*
-rw-r--r--. 1 root root 165625 Dec  1 21:18 tap.data.0
-rw-r--r--. 1 root root      0 Dec  1 21:18 tap.data
</pre>
</div>
</div>

<div id="outline-container-sec-12-4-6" class="outline-4">
<h4 id="sec-12-4-6"><span class="section-number-4">12.4.6</span> Writing into a Socket</h4>
<div class="outline-text-4" id="text-12-4-6">
<ul class="org-ul">
<li>Writing a socket, instead of a file, makes no difference for
working with dnstap output, but requires a socket reader.
</li>
</ul>
<pre class="example">
options {
 [...]
 dnstap {all;};
 dnstap-output unix "/etc/namedb/dnstap.sock";
 [...]
};
</pre>
<ul class="org-ul">
<li>Start the socket listener before starting named.
</li>
<li>Here we use fstrm<sub>capture</sub>, a socket reader packaged with the <code>fstrm</code>
library.
</li>
</ul>
<pre class="example">
% fstrm_capture -t protobuf:dnstap.Dnstap  \
                -u /etc/namedb/dnstap.sock \
                -w /etc/namedb/dnstap.out &amp;
[1] 22935
fstrm_capture: opening Unix socket path dnstap.sock
fstrm_capture: opened output file dnstap.out
#
% ls -l /etc/namedb/dnstap.sock
srwxr-xr-x. 1 root root 0 Dec  9 20:20 /etc/namedb/dnstap.sock
</pre>
<ul class="org-ul">
<li><code>-t</code> (&#x2013;type): The content-type to receive from the socket &amp; write
to the output file
<ul class="org-ul">
<li>(protobuf:dnstap.Dnstap is the only value the course developer has
seen used.)
</li>
</ul>
</li>
<li><code>-u</code> (&#x2013;unix): Specify the UNIX domain socket.
</li>
<li><code>-w</code> (&#x2013;write): Data from the socket is written to this file (in
dnstap data format).
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-4-7" class="outline-4">
<h4 id="sec-12-4-7"><span class="section-number-4">12.4.7</span> Exercise</h4>
<div class="outline-text-4" id="text-12-4-7">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Configure dnstap on your recursive server (dnsrNN)
<pre class="example">
dnstap { all; };
dnstap-output file "bind9-resolver.tap" size 1M versions 10 suffix timestamp;
dnstap-identity "dnsrNN-server";
</pre>
</li>
<li>Issue a few queries at it
</li>
<li>Have named flush the tap file and rotate it
<pre class="example">
% rndc dnstap -roll
</pre>
</li>
<li>Look at the content of the tap file:
<pre class="example">
% dnstap-read tap.YYYYMMDD*
% dnstap-read -y tap.YYYYMMDD*
</pre>
</li>
</ul>
<p>
</div>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-12-5" class="outline-3">
<h3 id="sec-12-5"><span class="section-number-3">12.5</span> CHAOS: An Information Source (Built-in server information zones)</h3>
<div class="outline-text-3" id="text-12-5">
</div><div id="outline-container-sec-12-5-1" class="outline-4">
<h4 id="sec-12-5-1"><span class="section-number-4">12.5.1</span> CHAOS &amp; HESIOD Classes</h4>
<div class="outline-text-4" id="text-12-5-1">
<ul class="org-ul">
<li>The rarely used DNS network classes <i>Chaos</i> (<code>CH</code>) and <i>Hesiod</i> (<code>HS</code>) were
developed at MIT.
</li>
<li>The ISC has repurposed Chaos providing TXT RRs with BIND server
information.
<ul class="org-ul">
<li><code>version.bind</code>
</li>
<li><code>hostname.bind</code>
</li>
<li><code>id.server</code>
</li>
<li><code>authors.bind</code>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-12-5-2" class="outline-4">
<h4 id="sec-12-5-2"><span class="section-number-4">12.5.2</span> version.bind</h4>
<div class="outline-text-4" id="text-12-5-2">
<ul class="org-ul">
<li>The version can be set to any string with the <code>version string;</code>
stanza in <code>options {};</code>
</li>
</ul>
<pre class="example">
$ dig +noall +answer ch TXT version.bind  @::1
version.bind.		0	CH	TXT 	"9.13.3"
$ dig +noall +answer @ams.sns-pb.isc.org. ch TXT version.bind
version.bind.		0	CH	TXT	"9.9.7-P2"
$ dig +noall +answer chaos TXT version.bind @ns4.tidelock.de
version.bind.		0	CH	TXT 	""

$ dig +noall +answer chaos TXT version.bind @i.root-servers.net
version.bind.		0	CH	TXT	"contact info@netnod.se"
</pre>
</div>
</div>
<div id="outline-container-sec-12-5-3" class="outline-4">
<h4 id="sec-12-5-3"><span class="section-number-4">12.5.3</span> hostname.bind</h4>
<div class="outline-text-4" id="text-12-5-3">
<ul class="org-ul">
<li><code>hostname.bind</code> defaults to the string the *NIX command <code>uname -n</code>
returns.
<ul class="org-ul">
<li>Set it with <code>hostname string;</code> in <code>options {};</code>.
</li>
<li>It can be used to identify which of a group of anycasts servers
is answering a query.
</li>
</ul>
</li>
</ul>
<pre class="example">
$ dig +noall +answer chaos TXT hostname.bind @g.root-servers.net
hostname.bind.		0	CH	TXT	  "g.root-servers-pac2-1.net"

$ dig +noall +answer ch TXT hostname.bind @::1
hostname.bind.		0	CH	TXT	 "student2"
</pre>
</div>
</div>
<div id="outline-container-sec-12-5-4" class="outline-4">
<h4 id="sec-12-5-4"><span class="section-number-4">12.5.4</span> id.server</h4>
<div class="outline-text-4" id="text-12-5-4">
<ul class="org-ul">
<li>By default, <code>id.server</code> is not a RR.
<ul class="org-ul">
<li>Set it with <code>server-id string;</code> in <code>options {};</code>.Default:
<code>server-id none;</code>
</li>
<li>It can be used to identify which of a group of anycasts servers
is answering a query.
</li>
</ul>
</li>
</ul>
<pre class="example">
$ dig +noall +answer chaos TXT id.server @k.root-servers.net
id.server.		0	CH	TXT	"ns1.ch-zrh.k.ripe.net"

$ dig +noall +answer chaos TXT id.server @f.root-servers.net
id.server.		0	CH	TXT	"cdg1b.f.root-servers.org"
</pre>
</div>
</div>
<div id="outline-container-sec-12-5-5" class="outline-4">
<h4 id="sec-12-5-5"><span class="section-number-4">12.5.5</span> Turning off answers from the CHAOS class</h4>
<div class="outline-text-4" id="text-12-5-5">
<ul class="org-ul">
<li>by default, BIND 9 answers queries to internal information in the
CHAOS class (a network class not used in production anymore and
repurposed for internet DNS server data)
</li>
<li>the DNS queries in the chaos class are
<ul class="org-ul">
<li><code>dig @&lt;server&gt; ch TXT version.bind</code> - ask for the BIND 9 server software
version
</li>
<li><code>dig @&lt;server&gt; ch TXT authors.bind</code> - ask for the list of BIND 9
developers
</li>
<li><code>dig @&lt;server&gt; ch TXT hostname.bind</code> - ask for the BIND 9 server
hostname
</li>
<li><code>dig @&lt;server&gt; query +nsid</code> or <code>dig @&lt;server&gt; ch TXT server.id</code> -
ask for the server's ID (see <a href="https://tools.ietf.org/html/rfc4892">RFC 4892 Requirements for a
Mechanism Identifying a Name Server Instance</a> and <a href="https://tools.ietf.org/html/rfc5001">DNS Name Server
Identifier (NSID) Option</a>
</li>
</ul>
</li>
<li>example query with NSID
</li>
</ul>
<pre class="example">
$ dig +nsid google.com

; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el8 &lt;&lt;&gt;&gt; +nsid google.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 1785
;; flags: qr rd ra; QUERY: 1, ANSWER: 6, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
; NSID: 70 72 6f 64 2d 72 64 6e 73 72 65 73 6f 6c 76 65 72 30 32 2e 61 6d 73 33 2e 69 6e 74 65 72 6e 61 6c 2e 64 69 67 69 74 61 6c 6f 63 65 61 6e 2e 63 6f 6d ("prod-rdnsresolver02.ams3.internal.digitalocean.com")
;; QUESTION SECTION:
;google.com.                    IN      A

;; ANSWER SECTION:
google.com.             44      IN      A       108.177.126.100
google.com.             44      IN      A       108.177.126.113
google.com.             44      IN      A       108.177.126.139
google.com.             44      IN      A       108.177.126.102
google.com.             44      IN      A       108.177.126.101
google.com.             44      IN      A       108.177.126.138

;; Query time: 1 msec
;; SERVER: 67.207.67.3#53(67.207.67.3)
;; WHEN: Tue May 26 05:41:20 UTC 2020
;; MSG SIZE  rcvd: 189
</pre>
<ul class="org-ul">
<li>turning off these information sources in BIND 9
</li>
</ul>
<pre class="example">
options {
   [...]
   server-id none;
   version none;
   hostname none;
};
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> DNS cookies</h2>
<div class="outline-text-2" id="text-13">
<ul class="org-ul">
<li>DNS Cookies provide protection for:
<ol class="org-ol">
<li>Queriers (stub resolvers or RDNS servers)
</li>
<li>Domain name owners
</li>
<li>The innocent
</li>
<li>DNS servers
</li>
</ol>
</li>
</ul>
</div>
<div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1"><span class="section-number-3">13.1</span> Protection for the Querier</h3>
<div class="outline-text-3" id="text-13-1">
<ul class="org-ul">
<li>Cookies protect a querier against bogus answers.
<ul class="org-ul">
<li>If the querier is a DNS resolver, cache poisoning is thwarted.
</li>
</ul>
</li>
</ul>


<figure>
<p><img src="./img/0901-DNS-cookies.png" class="img-responsive" alt="0901-DNS-cookies.png">
</p>
</figure>
</div>
</div>
<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2"><span class="section-number-3">13.2</span> Protection for the Domain Name Owner/Publisher</h3>
<div class="outline-text-3" id="text-13-2">
<ul class="org-ul">
<li>A bogus answer additionally injures the owner of the fraudulently
answered domain name.
</li>
</ul>


<figure>
<p><img src="./img/0902-DNS-cookies.png" class="img-responsive" alt="0902-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-3" class="outline-3">
<h3 id="sec-13-3"><span class="section-number-3">13.3</span> Protection for the Innocent</h3>
<div class="outline-text-3" id="text-13-3">
<ul class="org-ul">
<li>Cookie protect an innocent victim against spoofed IP address
attacks.
</li>
</ul>

<p>
<img id="Reflection-Attack" class="img-responsive" src="img/Reflection-Attack-00.png"></ p><input type="button" onclick="NextPage('Reflection-Attack','2')" value=">" /><input type="button" onclick="ResetSlides('Reflection-Attack')" value="O" /><input type="button" onclick="PrevPage('Reflection-Attack')" value="<" />
</p>
</div>
</div>

<div id="outline-container-sec-13-4" class="outline-3">
<h3 id="sec-13-4"><span class="section-number-3">13.4</span> Protection for the DNS Server</h3>
<div class="outline-text-3" id="text-13-4">
<ul class="org-ul">
<li>Cookie protects DNS servers from being DoS victims &amp; from being misused in reflection attacks.
<ul class="org-ul">
<li>This works for both authoritative and resolver servers.
</li>
</ul>
</li>
</ul>


<figure>
<p><img src="./img/0904-DNS-cookies.png" class="img-responsive" alt="0904-DNS-cookies.png">
</p>
</figure>

<p>
Cookies allow DNS servers to quickly respond to spoofed IPs, avoiding
the cost of handling the query, avoiding applying other secure
mechanisms (e.g response rate limiting), and reducing CPU usage. (This
protects the server from being a victim of a DoS attack) With cookies,
the server limits its misuse in a reflection, making the Internet a
better place.
</p>
</div>
</div>

<div id="outline-container-sec-13-5" class="outline-3">
<h3 id="sec-13-5"><span class="section-number-3">13.5</span> DNS Client Cookies</h3>
<div class="outline-text-3" id="text-13-5">
<ul class="org-ul">
<li>Client cookies <b>automatically</b> protect a querier from bogus answers
and from cache poisoning.
</li>
<li>This further protects the domain owner!
<ul class="org-ul">
<li>An attacker can not provide bogus RRs for her domain.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-13-6" class="outline-3">
<h3 id="sec-13-6"><span class="section-number-3">13.6</span> DNS Server Cookies</h3>
<div class="outline-text-3" id="text-13-6">
<ul class="org-ul">
<li>Server cookies <b>allow</b> a server to authenticate that queries are
not from a spoofed IP.
</li>
<li>This protects a victim whose IP has been spoofed.
</li>
<li>This protects the server against DoS.
<ul class="org-ul">
<li>It can quickly respond to the query before executing costly work
(e.g. DNSSEC crypto for any server, recursion for DNS resolver)
</li>
</ul>
</li>
<li>Server Cookies require BIND configuration.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-13-7" class="outline-3">
<h3 id="sec-13-7"><span class="section-number-3">13.7</span> Off-Path Attacks</h3>
<div class="outline-text-3" id="text-13-7">
<ul class="org-ul">
<li>Cookie security is against off-path attacks.
<ul class="org-ul">
<li>If an attacker has the packets between the querier &amp; server,
cookies add no security.
</li>
</ul>
</li>
</ul>

<figure>
<p><img src="./img/0905-DNS-cookies.png" class="img-responsive" alt="0905-DNS-cookies.png">
</p>
</figure>
</div>
</div>
<div id="outline-container-sec-13-8" class="outline-3">
<h3 id="sec-13-8"><span class="section-number-3">13.8</span> Client/Server Support</h3>
<div class="outline-text-3" id="text-13-8">
<ul class="org-ul">
<li>Cookies require support from querier and server.
<ul class="org-ul">
<li>If implemented by only one side, cookies are ignored.
</li>
</ul>
</li>
<li>With cookies, port randomization is not required.
</li>
</ul>

<figure>
<p><img src="./img/0906-DNS-cookies.png" class="img-responsive" alt="0906-DNS-cookies.png">
</p>
</figure>
</div>
</div>
<div id="outline-container-sec-13-9" class="outline-3">
<h3 id="sec-13-9"><span class="section-number-3">13.9</span> DNS Cookie Facts</h3>
<div class="outline-text-3" id="text-13-9">
<ul class="org-ul">
<li>Cookies are 64-bit pseudorandom values.
</li>
<li>They are an OPT RR option, and thus require EDNS.
</li>
<li>A server doesn't store per-client state.
<ul class="org-ul">
<li>It doesn't store any cookie state.
</li>
</ul>
</li>
<li>DNS cookies are not related to browser cookies.
</li>
<li><a href="https://tools.ietf.org/html/rfc7873">RFC 7873.  2016-05. Domain Name System (DNS) Cookies</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-13-10" class="outline-3">
<h3 id="sec-13-10"><span class="section-number-3">13.10</span> Cookies: Initial Query</h3>
<div class="outline-text-3" id="text-13-10">

<figure>
<p><img src="./img/0907-DNS-cookies.png" class="img-responsive" alt="0907-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-11" class="outline-3">
<h3 id="sec-13-11"><span class="section-number-3">13.11</span> Cookies: Initial Query Response</h3>
<div class="outline-text-3" id="text-13-11">

<figure>
<p><img src="./img/0908-DNS-cookies.png" class="img-responsive" alt="0908-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-12" class="outline-3">
<h3 id="sec-13-12"><span class="section-number-3">13.12</span> Cookies: Client Security</h3>
<div class="outline-text-3" id="text-13-12">

<figure>
<p><img src="./img/0909-DNS-cookies.png" class="img-responsive" alt="0909-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-13" class="outline-3">
<h3 id="sec-13-13"><span class="section-number-3">13.13</span> Cookies: Client Caching</h3>
<div class="outline-text-3" id="text-13-13">

<figure>
<p><img src="./img/0910-DNS-cookies.png" class="img-responsive" alt="0910-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-14" class="outline-3">
<h3 id="sec-13-14"><span class="section-number-3">13.14</span> Cookies: Subsequent Queries</h3>
<div class="outline-text-3" id="text-13-14">

<figure>
<p><img src="./img/0911-DNS-cookies.png" class="img-responsive" alt="0911-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-15" class="outline-3">
<h3 id="sec-13-15"><span class="section-number-3">13.15</span> Cookies: Valid Server Cookie</h3>
<div class="outline-text-3" id="text-13-15">
<ul class="org-ul">
<li>What happens if the server cookie is valid?
</li>
</ul>


<figure>
<p><img src="./img/0912-DNS-cookies.png" class="img-responsive" alt="0912-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-16" class="outline-3">
<h3 id="sec-13-16"><span class="section-number-3">13.16</span> Cookies: Invalid Server Cookie</h3>
<div class="outline-text-3" id="text-13-16">

<figure>
<p><img src="./img/0913-DNS-cookies.png" class="img-responsive" alt="0913-DNS-cookies.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-13-17" class="outline-3">
<h3 id="sec-13-17"><span class="section-number-3">13.17</span> Cookies in BIND 9</h3>
<div class="outline-text-3" id="text-13-17">
<ul class="org-ul">
<li>Beginning with 9.11, dig sends cookies by default.
</li>
<li>(Standard) Cookie support in <code>dig</code> began with 9.10.3.
</li>
<li>These <code>dig</code> options are directly related to cookies. (The first two
are enabled by default.)
<ul class="org-ul">
<li><code>+[no]cookie</code> - Add a (random) client COOKIE to queries
</li>
<li><code>+[no]badcookie</code> - Re-query upon a BADCOOKIE response
</li>
<li><code>+cookie=X</code> - Send cookie X, a server or client cookie
</li>
</ul>
</li>

<li>If a query has a valid server cookie, RRL (Response Rate Limiting)
is not applied.
<ul class="org-ul">
<li><code>named.conf</code> has configuration <code>options{};</code> related to cookies.
<ul class="org-ul">
<li>Other options, such as those for EDNS, also play a roll.
</li>
</ul>
</li>
</ul>
</li>
<li><code>require-server-cookie boolean;</code>
<ul class="org-ul">
<li>Default <code>no</code>. <code>yes</code>: query without cookie response = <code>BADCOOKIE</code>
</li>
<li>This is the most important option.
</li>
</ul>
</li>
<li><code>require-cookie boolean;</code> (inside a <code>server {};</code> block, BIND 9.20+)
<ul class="org-ul">
<li>This option specifies whether there should be a DNS COOKIE in the
response for a given IP address/server; if not, named falls back
to TCP. This is useful if it is known that a given server
supports DNS COOKIE. It can also be used to force all non-DNS
COOKIE responses to fall back to TCP.
</li>
</ul>
</li>
<li><code>cookie-algorithm (aes|siphash24);</code>
<ul class="org-ul">
<li>Default= <code>aes</code> (BIND 9.18 and earlier) / <code>siphash24</code> (BIND 9.20+)
</li>
</ul>
</li>
<li><code>cookie-secret string;</code>
<ul class="org-ul">
<li>Default= <code>random</code>. Necessary to set this value to fixed content
of all machines that are part of an (anycast) cluster.
</li>
</ul>
</li>
<li><code>nocookie-udp-size integer;</code>
<ul class="org-ul">
<li>If Query has no cookie, limit UDP response size. Default=4096B. Lowest allowed 128B.
</li>
</ul>
</li>
<li><code>send-cookie boolean;</code>
<ul class="org-ul">
<li>Default= <code>yes</code>.  Option is for DNS resolver server servers.
</li>
<li><code>send-cookie</code> can also be used in a <code>server {};</code>
statement. Setting it to <code>no</code> works around a broken server not
properly handling cookies.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-13-18" class="outline-3">
<h3 id="sec-13-18"><span class="section-number-3">13.18</span> Cookies in dig: Server Cookie</h3>
<div class="outline-text-3" id="text-13-18">
<ul class="org-ul">
<li>This server cookie is valid (good).
</li>
</ul>
<pre class="example">
$ dig @ns12a.dnslab.org zone12.dnslab.org +nocmd +noqu +norec

; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el8 &lt;&lt;&gt;&gt; @ns12a.dnslab.org zone12.dnslab.org +nocmd +noqu +norec
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 15954
;; flags: qr aa; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 77eb710a2d489ed5010000005ecdff33b816374a28e8fde5 (good)
;; ANSWER SECTION:
zone12.dnslab.org.	60	IN	A	161.35.224.95

;; Query time: 155 msec
;; SERVER: 161.35.224.95#53(161.35.224.95)
;; WHEN: Wed May 27 05:48:35 UTC 2020
;; MSG SIZE  rcvd: 88
</pre>
<ul class="org-ul">
<li>Identical queries, but dig doesn't save server cookies, or even its
own client cookie. Each time dig queries it use a new client
cookie, and thus get a new server cookie.
</li>
</ul>
<pre class="example">
;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 41cb7f09d4942eb3010000005ecdff829ab46f795ab83c4c (good)
</pre>
<ul class="org-ul">
<li>and another
</li>
</ul>
<pre class="example">
;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: bf7e888966399c5b010000005ecdff985ecbdb747d5b7955 (good)
</pre>
</div>
</div>
<div id="outline-container-sec-13-19" class="outline-3">
<h3 id="sec-13-19"><span class="section-number-3">13.19</span> Cookies in dig: Client Cookie</h3>
<div class="outline-text-3" id="text-13-19">
<ul class="org-ul">
<li>The command line switch <code>+qr</code> makes <code>dig</code> print the outgoing query
in addition to the received answer. We see the client cookie in the
outgoing query.
</li>
</ul>
<pre class="example">
$ dig @ns12a.dnslab.org zone12.dnslab.org +nocmd +qr +norec

; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el8 &lt;&lt;&gt;&gt; @ns12a.dnslab.org zone12.dnslab.org +nocmd +qr +norec
; (1 server found)
;; global options: +cmd
;; Sending:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 10846
;; flags: ad; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 919e4f49e09f6d5d
;; QUESTION SECTION:
;zone12.dnslab.org.		IN	A

;; QUERY SIZE: 56

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 10846
;; flags: qr aa; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 919e4f49e09f6d5d010000005ecdffcd693be2fca534ac93 (good)
;; QUESTION SECTION:
;zone12.dnslab.org.		IN	A

;; ANSWER SECTION:
zone12.dnslab.org.	60	IN	A	161.35.224.95

;; Query time: 155 msec
;; SERVER: 161.35.224.95#53(161.35.224.95)
;; WHEN: Wed May 27 05:51:09 UTC 2020
;; MSG SIZE  rcvd: 88
</pre>
</div>
</div>
<div id="outline-container-sec-13-20" class="outline-3">
<h3 id="sec-13-20"><span class="section-number-3">13.20</span> Exercise</h3>
<div class="outline-text-3" id="text-13-20">
<p>
<div class="exercise">
</p>
<ul class="org-ul">
<li>Configure <code>require-server-cookie yes;</code> in the <code>options</code> block of
the primary authoritative servers (<code>nsNNa</code>)
</li>
<li>Check the configuration and reload
</li>
<li>Send two queries with an invalid server cookie, one to the primary
(requires a good cookie), one to the secondary (runs with the
default cookie configuration)
</li>
</ul>
<pre class="example">
dig @nsNNa.dnslab.org zoneNN.dnslab.org  \
    +norec +noall +comment +nobadcookie \
    +cookie=0123456789abcdef0123456789abcdef0123456789abcdef
dig @nsNNb.dnslab.org zoneNN.dnslab.org  \
    +norec +noall +comment +nobadcookie \
    +cookie=0123456789abcdef0123456789abcdef0123456789abcdef
</pre>
<ul class="org-ul">
<li>Post the return code received for <code>nsNNa</code> and <code>nsNNb</code> to the chat
</li>
</ul>
<p>
</div>
</p>


<p>
<hr />
</p>
</div>
</div>
</div>
</div></div></div>
<footer id="postamble" class="">
<div><p class="date">Date: <span class="timestamp-wrapper"><span class="timestamp">&lt;2024-10-28 Mon&gt;</span></span></p>
<p class="author">Author: BlueCat Learning Team</p>
<p class="date">Created: 2024-10-30 Wed 18:14</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 29.4 (<a href="http://orgmode.org">Org-mode</a> 9.1.4)</p>
</div>
</footer>
</body>
</html>
